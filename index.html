<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mr. Stylo Academy | Premium Mock Test</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- MathJax Support -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          processEnvironments: true
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
          ignoreHtmlClass: 'tex-ignore'
        },
        startup: {
          ready: () => {
            MathJax.startup.defaultReady();
            MathJax.texReset();
            MathJax.typesetClear();
            MathJax.typesetPromise();
          }
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* ==================== THEME VARIABLES ==================== */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: #ffffff;
            --font-main: 'Noto Serif Bengali', serif;
            --font-num: 'Poppins', sans-serif;
            --color-primary: #6c5ce7;
            --color-danger: #d63031;
            --color-success: #00b894;
        }

        /* ==================== BASE STYLES ==================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; padding: 0; 
            background: #dfe6e9; 
            font-family: var(--font-main); 
            color: #2d3436;
            height: 100vh; height: 100dvh;
            display: flex; justify-content: center;
            overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }

        input, textarea, select { -webkit-user-select: text; user-select: text; }

        .container { 
            width: 100%; max-width: 550px; 
            background: var(--glass-bg); 
            height: 100%; position: relative; 
            display: flex; flex-direction: column; 
            z-index: 10; overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Utility */
        .hidden { display: none !important; }
        .p-20 { padding: 20px; }
        .font-num { font-family: var(--font-num); }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        /* ==================== BUTTONS & CHIPS ==================== */
        .btn { 
            width: 100%; padding: 12px; border: none; border-radius: 8px; 
            font-weight: 600; cursor: pointer; margin-top: 10px; 
            font-size: 0.95rem; transition: transform 0.1s; 
            font-family: var(--font-main); 
            display: flex; justify-content: center; align-items: center;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 3px 8px rgba(108, 92, 231, 0.3); }
        .btn-danger { background: #ff7675; color: white; }
        .btn-outline { background: white; border: 1.5px solid #dfe6e9; color: #636e72; }
        .btn-save { background: linear-gradient(135deg, #0984e3, #6c5ce7); color: white; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3); border:none; }

        /* Category Chips */
        .cat-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .cat-scroll::-webkit-scrollbar { display: none; }
        .cat-chip {
            padding: 5px 12px; background: white; border: 1px solid #dfe6e9;
            border-radius: 20px; white-space: nowrap; font-size: 0.8rem;
            color: #636e72; cursor: pointer; transition: 0.2s;
        }
        .cat-chip.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }

        /* Pagination Controls */
        .pagination-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .page-btn { padding: 8px 15px; background: white; border: 1px solid #dfe6e9; border-radius: 8px; cursor: pointer; font-size: 0.8rem; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 0.8rem; color: #636e72; }

        /* ==================== EXAM VIEW CSS ==================== */
        .exam-layout { display: flex; flex-direction: column; height: 100%; }
        
        .exam-header { 
            background: white; padding: 10px 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #f1f2f6; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            z-index: 20; height: 50px;
        }
        
        .timer-badge { 
            background: #d63031; color: white; padding: 4px 10px; 
            border-radius: 20px; font-weight: bold; font-family: var(--font-num); font-size: 0.85rem;
        }

        .scroll-area { 
            flex: 1; overflow-y: auto; padding: 20px; 
            background: #f8f9fa; -webkit-overflow-scrolling: touch; 
        }

        .question-card { margin-bottom: 20px; }
        #q-text { font-size: 1.05rem; line-height: 1.5; color: #2d3436; margin: 0 0 12px 0; font-weight: 600; }
        
        .option-btn { 
            background: white; border: 1.5px solid #e0e0e0; 
            padding: 12px; border-radius: 10px; margin-bottom: 8px; 
            cursor: pointer; width: 100%; text-align: left; 
            transition: 0.2s; font-size: 0.95rem; color: #555;
            position: relative;
        }
        .option-btn.selected { background: #eef2ff; border-color: #6c5ce7; color: #6c5ce7; font-weight: 600; }

        /* Footer Bar (Exam) */
        .footer-bar { 
            padding: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
            background: white; border-top: 1px solid #f1f2f6; 
            display: flex; gap: 8px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 30;
        }
        .footer-btn { flex: 1; padding: 8px 2px; margin: 0; font-size: 0.8rem; border-radius: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-save { flex: 1.2; }

        /* App Footer (Dashboard) */
        .app-footer {
            text-align: center; padding: 20px; color: #b2bec3; 
            font-size: 0.75rem; border-top: 1px solid #f1f2f6;
            margin-top: auto; background: #fdfdfd;
        }

        /* ==================== SIDE PANEL ==================== */
        .side-panel { 
            position: absolute; top: 0; right: -100%; width: 80%; max-width: 300px; 
            height: 100%; background: white; z-index: 2000; 
            box-shadow: -10px 0 30px rgba(0,0,0,0.2); 
            transition: right 0.3s ease; display: flex; flex-direction: column; 
        }
        .side-panel.open { right: 0; }
        .overlay-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1900; display: none; }
        .overlay-bg.active { display: block; }
        
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 15px; overflow-y: auto; }
        .palette-btn { 
            height: 35px; border-radius: 6px; border: 1px solid #eee; background: #f9f9f9; 
            display: flex; justify-content: center; align-items: center; 
            font-weight: 600; cursor: pointer; font-family: var(--font-num); color: #636e72; font-size: 0.9rem;
        }
        .palette-btn.active { 
            border: 2px solid #6c5ce7 !important; 
            background: white !important; 
            color: #6c5ce7 !important; 
            box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.2);
            position: relative;
            z-index: 1;
        }
        .palette-btn.answered { 
            background: #00b894 !important; 
            color: white !important; 
            border: 1px solid #00b894 !important; 
        }
        .palette-btn.review { 
            background: #a29bfe !important; 
            color: white !important; 
            border: 1px solid #a29bfe !important; 
        }
        .palette-btn.answered.active { 
            border: 2px solid #6c5ce7 !important;
            background: #00b894 !important;
        }
        .palette-btn.review.active { 
            border: 2px solid #6c5ce7 !important;
            background: #a29bfe !important;
        }

        /* Legend Style */
        .legend-box {
            padding: 10px 15px; background: #f8f9fa; border-top: 1px solid #eee;
            font-size: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; color: #636e72; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        /* ==================== POPUP ==================== */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .popup-box { 
            background: white; padding: 20px; border-radius: 12px; 
            width: 85%; max-width: 300px; text-align: center; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: popIn 0.3s; 
        }
        @keyframes popIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        /* Stats & Results */
        .result-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .result-table td, .result-table th { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .stat-item { background: #f4f6f8; padding: 8px; border-radius: 6px; font-size: 0.75rem; border: 1px solid #eee; }

        /* MathJax Styling */
        .math-content {
            font-family: 'Noto Serif Bengali', serif;
            line-height: 1.5;
        }

        .mjx-chtml {
            font-size: 1em !important;
        }

        .MJX-TEX {
            font-size: 1em;
        }

        /* Review answer highlighting */
        .correct-answer {
            background-color: #d4edda !important;
            border: 1px solid #c3e6cb !important;
        }

        .wrong-answer {
            background-color: #f8d7da !important;
            border: 1px solid #f5c6cb !important;
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; 
            if(e.ctrlKey && (e.keyCode == 'U'.charCodeAt(0) || e.keyCode == 'S'.charCodeAt(0))) return false;
        }
    </script>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="container" id="app-container">

    <div id="custom-popup" class="popup-overlay hidden">
        <div class="popup-box">
            <div style="font-size: 2.5rem; margin-bottom: 5px;" id="pop-icon">‚ö†Ô∏è</div>
            <h3 id="pop-title" style="margin: 5px 0; color:#2d3436; font-size:1.1rem;">Alert</h3>
            <p id="pop-msg" style="color: #636e72; margin-bottom: 15px; font-size: 0.9rem;">Message</p>
            <div style="display:flex; gap:10px;">
                <button id="btn-pop-cancel" class="btn btn-outline" style="margin:0; flex:1; padding:8px;">Cancel</button>
                <button id="btn-pop-ok" class="btn btn-primary" style="margin:0; flex:1; padding:8px;">OK</button>
            </div>
        </div>
    </div>

    <div id="side-overlay" class="overlay-bg" onclick="togglePanel(false)"></div>
    <div id="side-panel" class="side-panel">
        <div class="exam-header" style="background:#f8f9fa;">
            <span style="font-weight:bold;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</span>
            <button onclick="togglePanel(false)" style="background:none; border:none; font-size:1.2rem;">‚úï</button>
        </div>
        <div style="flex:1; overflow-y:auto;">
            <div id="palette-grid" class="palette-grid"></div>
        </div>
        
        <div class="legend-box">
            <div class="legend-item"><span class="dot" style="background:#f9f9f9; border:1px solid #ddd;"></span> ‡¶¨‡¶æ‡¶ï‡¶ø (Not Visited)</div>
            <div class="legend-item"><span class="dot" style="background:white; border:1.5px solid #6c5ce7;"></span> ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® (Current)</div>
            <div class="legend-item"><span class="dot" style="background:#00b894;"></span> ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ</div>
            <div class="legend-item"><span class="dot" style="background:#a29bfe;"></span> ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â (Marked)</div>
        </div>

        <div style="padding:15px; border-top:1px solid #eee; background:white;">
            <button onclick="confirmSubmit()" class="btn btn-danger" style="margin:0;">üöÄ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- ‡¶´‡¶æ‡¶∞‡ßç‡¶∏‡ßç‡¶ü ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶≠‡¶ø‡¶â -->
    <div id="view-first-setup" class="hidden p-20" style="display:flex; flex-direction:column; justify-content:center; height:100%;">
        <div style="text-align:center; margin-bottom:30px;">
            <h2 style="color:var(--color-primary);">üîí ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™</h2>
            <p style="color:#636e72;">‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
        </div>
        
        <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
            <h4 style="margin-top:0;">‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
            <input type="text" id="setup-admin-id" placeholder="‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <input type="password" id="setup-admin-pass" placeholder="‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <input type="password" id="setup-admin-pass-confirm" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:15px;">
            
            <h4 style="margin-top:20px;">‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</h4>
            <input type="password" id="setup-review-pass" placeholder="‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <input type="password" id="setup-review-pass-confirm" placeholder="‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px;">
        </div>
        
        <div style="background:#fff3cd; border:1px solid #ffeaa7; padding:15px; border-radius:8px; margin-bottom:20px;">
            <p style="margin:0; color:#856404; font-size:0.9rem;">
                ‚ö†Ô∏è <strong>‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:</strong> ‡¶è‡¶á ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§
            </p>
        </div>
        
        <button onclick="completeFirstSetup()" class="btn btn-primary">‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="location.reload()" class="btn btn-outline" style="margin-top:10px;">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="view-dashboard" style="display:flex; flex-direction:column; height:100%;">
        <div style="background:var(--primary-gradient); color:white; padding:20px 15px; text-align:center; border-radius:0 0 20px 20px; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.2);">
            <h3 style="font-family: var(--font-num); margin:0; font-size:1.3rem;">Mr. Stylo Academy</h3>
            <p style="margin:2px 0; opacity:0.9; font-size:0.8rem;">Premium Mock Test Platform</p>
        </div>
        
        <div class="p-20" style="flex:1; overflow-y:auto;">
            <div class="cat-scroll" id="home-cat-container">
                <div class="cat-chip active">All</div>
                </div>

            <div id="exam-list">
                <div style="text-align:center; padding:50px; color:#b2bec3;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
            </div>

            <div id="pagination-controls" class="pagination-bar hidden">
                <button onclick="changePage(-1)" id="btn-prev" class="page-btn">Previous</button>
                <span id="page-info" class="page-info font-num">Page 1</span>
                <button onclick="changePage(1)" id="btn-next" class="page-btn">Next</button>
            </div>
            
            <button onclick="switchView('admin-login')" class="btn btn-outline" style="margin-top:20px; border-style:dashed; color:#636e72; font-size:0.8rem;">üë®‚Äçüè´ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶≤‡¶ó‡¶á‡¶®</button>
        </div>

        <div class="app-footer">
            <p style="margin:0;">&copy; 2026 Mr. Stylo Academy</p>
            <p style="margin:2px 0; font-size:0.7rem;">Designed for Excellence</p>
        </div>
    </div>

    <div id="view-intro" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <div style="text-align:center; margin:20px 0;">
            <span id="intro-cat-badge" style="background:#dfe6e9; padding:4px 10px; border-radius:15px; font-size:0.8rem; color:#636e72;">Category</span>
            <h2 id="intro-title" style="color:var(--color-primary); margin:5px 0 0 0; font-size:1.4rem;">Exam Name</h2>
        </div>
        <div style="background:white; border-radius:12px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.05); margin-bottom:20px; border:1px solid #f1f2f6;">
            <div class="stat-grid" style="margin-top:0;">
                <div class="stat-item">‚è±Ô∏è ‡¶∏‡¶Æ‡ßü: <b id="intro-time" class="font-num">0</b> Min</div>
                <div class="stat-item">üìù ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: <b id="intro-q" class="font-num">0</b> Qs</div>
                <div class="stat-item">üéØ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶∏: <b id="intro-total-marks" class="font-num">0</b></div>
                <div class="stat-item" style="color:red;">‚ö†Ô∏è ‡¶®‡ßá‡¶ó‡ßá‡¶ü‡¶ø‡¶≠: <b id="intro-neg" class="font-num">0.25</b></div>
            </div>
        </div>
        <label style="font-weight:600; font-size:0.9rem; color:#2d3436;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input type="text" id="student-name-input" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="border:2px solid #dfe6e9; width:100%; padding:12px; border-radius:10px; margin-top:5px; outline:none;" onpaste="return false;" ondrop="return false;">
        <button onclick="startRealExam()" class="btn btn-primary" style="margin-top:20px;">üöÄ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="switchView('dashboard')" class="btn btn-outline">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
    </div>

    <div id="view-exam" class="hidden exam-layout">
        <div class="exam-header">
            <span id="timer" class="timer-badge">00:00</span>
            <span id="display-name" style="font-weight:bold; font-size:0.9rem; color:#2d3436;">Student</span>
            <button onclick="togglePanel(true)" style="background:none; border:1px solid #ddd; border-radius:8px; width:35px; height:35px; cursor:pointer;">‚ò∞</button>
        </div>
        
        <div class="scroll-area">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.75rem; color:#636e72;">
                <span id="q-topic-badge" style="background:#e1e2e6; padding:3px 10px; border-radius:15px; font-weight:bold;">General</span>
                <span class="font-num">Marks: +<span id="q-pos">1</span> / -<span id="q-neg">0.25</span></span>
            </div>
            
            <div class="question-card">
                <img id="q-image" src="" style="max-width:100%; display:none; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
                <h3 id="q-text" class="math-content">Loading...</h3>
                <div id="options-container" class="math-content"></div>
            </div>
        </div>

        <div class="footer-bar">
            <button onclick="prevQ()" class="btn btn-outline footer-btn" style="flex:0.8;">Back</button>
            <button onclick="markAndNext()" class="btn btn-outline footer-btn" style="color:#6c5ce7; border-color:#a29bfe;">Mark</button>
            <button onclick="clearResponse()" class="btn btn-outline footer-btn">Clear</button>
            <button onclick="saveAndNext()" class="btn btn-save footer-btn" style="flex:1.2;">Save</button>
        </div>
    </div>

    <div id="view-result" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <div style="background:white; border-radius:16px; padding:20px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.05); margin-bottom:20px;">
            <h3 id="res-name" style="margin:0; color:#636e72;">Student</h3>
            <div style="width:80px; height:80px; border-radius:50%; border:4px solid #f1f2f6; margin:10px auto; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <span id="res-score" class="font-num" style="font-size:1.8rem; font-weight:bold; line-height:1; color:#2d3436;">0</span>
            </div>
            <div id="res-grade" style="font-weight:bold; color:var(--color-primary); font-size:1.1rem;">Grade</div>
            
            <div class="stat-grid">
                <div class="stat-item">‚è±Ô∏è <b id="res-time" class="font-num">0m</b></div>
                <div class="stat-item">üìä <b id="res-percent" class="font-num">0%</b></div>
                <div class="stat-item" style="color:var(--color-success);">‚úÖ <b id="res-correct" class="font-num">0</b></div>
                <div class="stat-item" style="color:var(--color-danger);">‚ùå <b id="res-wrong" class="font-num">0</b></div>
            </div>
        </div>
        
        <div style="background:white; padding:15px; border-radius:12px; margin-bottom:15px;">
            <h4 style="margin:0 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">üìä ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏</h4>
            <div id="topic-analysis-container"></div>
        </div>

        <button onclick="shareExam()" class="btn btn-success" style="margin-bottom:10px;">üì≤ ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü</button>
        <button onclick="switchView('review-login')" class="btn btn-primary">üëÅÔ∏è ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ (Review)</button>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="loadLeaderboard()" class="btn btn-outline" style="flex:1;">üèÜ ‡¶Æ‡ßá‡¶ß‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</button>
            <button onclick="location.reload()" class="btn btn-outline" style="flex:1;">Home</button>
        </div>
    </div>

    <!-- ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶® ‡¶≠‡¶ø‡¶â - ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶ø‡¶ï‡¶ø‡¶ì‡¶∞ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ -->
    <div id="view-admin-login" class="hidden p-20" style="display:flex; flex-direction:column; justify-content:center; height:100%;">
        <h2 style="text-align:center;">üîê ‡¶∏‡¶ø‡¶ï‡¶ø‡¶ì‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶®</h2>
        
        <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px;">
            <input type="text" id="admin-id" placeholder="‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ" style="padding:12px; border:1px solid #ddd; border-radius:8px; width:100%; margin-bottom:10px;">
            <input type="password" id="admin-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°" style="padding:12px; border:1px solid #ddd; border-radius:8px; width:100%; margin-bottom:15px;">
            
            <div style="display:flex; gap:10px;">
                <button onclick="checkAdmin()" class="btn btn-primary" style="flex:1;">‡¶≤‡¶ó‡¶á‡¶®</button>
                <button onclick="switchView('dashboard')" class="btn btn-outline" style="flex:1;">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            </div>
        </div>
        
        <div style="text-align:center; font-size:0.8rem; color:#636e72;">
            <p>‚ö†Ô∏è ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡¶∞‡¶æ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®</p>
        </div>
    </div>

    <div id="view-admin-menu" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <div style="text-align:center; margin-bottom:20px;">
            <h2>üë®‚Äçüè´ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2>
            <p style="color:#636e72; font-size:0.9rem;">‡¶≤‡¶ó‡¶á‡¶®‡¶ï‡ßÉ‡¶§: <span id="logged-admin" style="font-weight:bold;"></span></p>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
            <button onclick="switchView('create-exam')" class="btn btn-primary" style="height:100px;">üìù<br>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</button>
            <button onclick="loadCategoriesAdmin()" class="btn btn-primary" style="height:100px; background:#a29bfe; color:#333;">üóÇÔ∏è<br>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</button>
            <button onclick="loadAdminResults()" class="btn btn-primary" style="background:#fab1a0; color:#333;">üìä ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü</button>
            <button onclick="loadManageExams()" class="btn btn-danger">üóëÔ∏è ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú</button>
            <button onclick="switchView('admin-settings')" class="btn btn-outline">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
            <button onclick="switchView('change-password')" class="btn btn-outline">üîê ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
        </div>
        
        <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px;">
            <h4 style="margin-top:0;">‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶§‡¶•‡ßç‡¶Ø</h4>
            <div style="font-size:0.85rem; color:#636e72;">
                <div>‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ: <span id="total-exams" class="font-num">0</span></div>
                <div>‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü: <span id="total-results" class="font-num">0</span></div>
                <div>‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ: <span style="color:#00b894;">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º</span></div>
            </div>
        </div>
        
        <button onclick="adminLogout()" class="btn btn-danger" style="margin-top:10px;">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
    </div>

    <!-- ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ - ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
    <div id="view-admin-settings" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <h3>‚öôÔ∏è ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
        
        <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px;">
            <h4 style="margin-top:0;">‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®</h4>
            
            <div style="margin-bottom:10px;">
                <label style="font-size:0.9rem; display:block; margin-bottom:5px;">‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶®‡¶æ‡¶Æ:</label>
                <input type="text" id="system-name" placeholder="‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶®‡¶æ‡¶Æ" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
            </div>
            
            <div style="margin-bottom:10px;">
                <label style="font-size:0.9rem; display:block; margin-bottom:5px;">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶Æ‡¶Ø‡¶º (‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü):</label>
                <input type="number" id="default-exam-time" value="30" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
            </div>
            
            <div style="margin-bottom:10px;">
                <label style="font-size:0.9rem; display:block; margin-bottom:5px;">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶™‡¶ú‡¶ø‡¶ü‡¶ø‡¶≠ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï:</label>
                <input type="number" step="0.25" id="default-positive-mark" value="1" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
            </div>
            
            <div style="margin-bottom:10px;">
                <label style="font-size:0.9rem; display:block; margin-bottom:5px;">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶®‡ßá‡¶ó‡ßá‡¶ü‡¶ø‡¶≠ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï:</label>
                <input type="number" step="0.25" id="default-negative-mark" value="0.25" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
            </div>
        </div>
        
        <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px;">
            <h4 style="margin-top:0;">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h4>
            
            <div style="margin-bottom:15px;">
                <h5 style="margin:10px 0 5px 0; font-size:0.9rem;">‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</h5>
                <input type="password" id="admin-new-password" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:8px;">
                <input type="password" id="admin-new-password-confirm" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
                <button onclick="changeAdminPasswordFromSettings()" class="btn btn-primary" style="width:100%; padding:8px; font-size:0.9rem;">‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
            </div>
            
            <div style="margin-bottom:15px; padding-top:15px; border-top:1px solid #eee;">
                <h5 style="margin:10px 0 5px 0; font-size:0.9rem;">‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</h5>
                <input type="password" id="review-new-password" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:8px;">
                <input type="password" id="review-new-password-confirm" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
                <button onclick="changeReviewPassword()" class="btn btn-primary" style="width:100%; padding:8px; font-size:0.9rem; background:#a29bfe; border:none;">‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
            </div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="saveSystemSettings()" class="btn btn-success" style="flex:1;">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button onclick="switchView('admin-menu')" class="btn btn-danger" style="flex:1;">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
        </div>
    </div>

    <!-- ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® -->
    <div id="view-change-password" class="hidden p-20" style="display:flex; flex-direction:column; justify-content:center; height:100%;">
        <h3 style="text-align:center;">üîê ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</h3>
        
        <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
            <div style="margin-bottom:15px;">
                <label style="font-size:0.9rem; display:block; margin-bottom:5px;">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°:</label>
                <input type="password" id="current-password" placeholder="‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px;">
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="font-size:0.9rem; display:block; margin-bottom:5px;">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°:</label>
                <input type="password" id="new-password" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px;">
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="font-size:0.9rem; display:block; margin-bottom:5px;">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <input type="password" id="confirm-password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px;">
            </div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="changeAdminPassword()" class="btn btn-primary" style="flex:1;">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
            <button onclick="switchView('admin-menu')" class="btn btn-outline" style="flex:1;">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
        </div>
    </div>

    <div id="view-categories" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <h3>üóÇÔ∏è ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú</h3>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input type="text" id="new-cat-name" placeholder="New Category Name..." style="padding:10px; flex:1; border:1px solid #ddd; border-radius:8px;">
            <button onclick="addCategory()" class="btn btn-success" style="width:auto; margin:0;">Add</button>
        </div>
        <div id="admin-cat-list"></div>
        <button onclick="switchView('admin-menu')" class="btn btn-danger" style="margin-top:20px;">Back</button>
    </div>

    <div id="view-create-exam" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <h3>üìù ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶§‡ßà‡¶∞‡¶ø</h3>
        <input type="text" id="new-title" placeholder="Exam Name" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
        
        <label style="font-size:0.8rem; color:#666; margin-left:5px;">Category:</label>
        <select id="new-category" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; background:white;">
            <option value="General">General</option>
            </select>

        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="number" id="new-time" placeholder="Time (m)" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
            <input type="number" id="mark-correct" value="1" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
            <input type="number" id="mark-wrong" value="0.25" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button onclick="toggleInputMode('json')" class="btn btn-outline" style="margin:0;">JSON</button>
            <button onclick="toggleInputMode('manual')" class="btn btn-outline" style="margin:0;">Manual</button>
        </div>
        
        <div id="mode-json"><textarea id="json-input" placeholder="Paste JSON..." style="width:100%; height:150px; border:1px solid #ddd;"></textarea></div>
        <div id="mode-manual" class="hidden">
            <div id="questions-wrapper"></div>
            <button onclick="addQuestionField()" class="btn btn-outline">‚ûï Add Q</button>
        </div>
        <div style="margin-top:20px; padding-bottom:50px;">
            <button id="btn-publish" class="btn btn-success">üöÄ PUBLISH</button>
            <button onclick="switchView('admin-menu')" class="btn btn-danger">Cancel</button>
        </div>
    </div>

    <div id="view-manage-exams" class="hidden p-20" style="overflow-y:auto; height:100%;"><h3 style="text-align:center;">Manage Exams</h3><div id="manage-exam-list"></div><button onclick="switchView('admin-menu')" class="btn btn-outline">Back</button></div>
    
    <!-- ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶™‡ßá‡¶ú - ‡¶™‡ßç‡¶Ø‡¶æ‡¶ú‡¶ø‡¶®‡ßá‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
    <div id="view-admin-results" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <h3 style="text-align:center;">Results</h3>
        <div id="result-table-container">
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Exam</th>
                        <th>Score</th>
                        <th>%</th>
                        <th>Correct/Total</th>
                    </tr>
                </thead>
                <tbody id="result-table-body"></tbody>
            </table>
        </div>
        <div id="result-pagination" class="pagination-bar hidden" style="margin-top:15px;">
            <button onclick="changeResultPage(-1)" id="btn-results-prev" class="page-btn">Previous</button>
            <span id="results-page-info" class="page-info font-num">Page 1</span>
            <button onclick="changeResultPage(1)" id="btn-results-next" class="page-btn">Next</button>
        </div>
        <button onclick="switchView('admin-menu')" class="btn btn-danger" style="margin-top:20px;">Back</button>
    </div>
    
    <div id="view-leaderboard" class="hidden p-20" style="overflow-y:auto; height:100%;"><h3 style="text-align:center;">Leaderboard</h3><p id="lb-exam-name" style="text-align:center; color:#666;"></p><div id="lb-list"></div><button onclick="switchView('result')" class="btn btn-primary" style="margin-top:20px;">Back</button></div>
    
    <!-- ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶≤‡¶ó‡¶á‡¶® - ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶ø‡¶ï‡¶ø‡¶ì‡¶∞ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ -->
    <div id="view-review-login" class="hidden p-20" style="display:flex; flex-direction:column; justify-content:center; height:100%;">
        <h2 style="text-align:center;">üîí ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶∏</h2>
        
        <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
            <input type="password" id="review-pass" placeholder="‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:15px;">
            
            <div style="display:flex; gap:10px;">
                <button onclick="checkReviewPass()" class="btn btn-primary" style="flex:1;">‡¶è‡¶®‡ßç‡¶ü‡¶æ‡¶∞</button>
                <button onclick="switchView('result')" class="btn btn-outline" style="flex:1;">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            </div>
        </div>
        
        <div style="text-align:center; font-size:0.8rem; color:#636e72;">
            <p>‚ö†Ô∏è ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶∞‡¶æ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®</p>
        </div>
    </div>

    <div id="view-review" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <div style="text-align:center; margin-bottom:10px;">
            <h3>‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞</h3>
            <p id="review-student-name" style="color:var(--color-primary); font-weight:bold;"></p>
        </div>
        <div style="display:flex; gap:5px; overflow-x:auto; margin-bottom:10px;">
            <button onclick="filterReview('all')" class="btn btn-outline" style="padding:5px 15px; width:auto; margin:0;">All</button>
            <button onclick="filterReview('wrong')" class="btn btn-outline" style="padding:5px 15px; width:auto; margin:0; color:red;">Wrong</button>
            <button onclick="filterReview('correct')" class="btn btn-outline" style="padding:5px 15px; width:auto; margin:0; color:green;">Correct</button>
        </div>
        <div id="review-list" style="padding-bottom:50px;"></div>
        <button onclick="switchView('result')" class="btn btn-primary">Back</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, Timestamp, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyC5hrI06t9N-K4GAlLxGc6pjb0-JyNC9c8", 
        authDomain: "myquizapp-7c5ac.firebaseapp.com", 
        projectId: "myquizapp-7c5ac", 
        storageBucket: "myquizapp-7c5ac.firebasestorage.app", 
        messagingSenderId: "685862319630", 
        appId: "1:685862319630:web:2997eda6844b3bf9d6ee5f" 
    };
    
    let app, db; 
    try { 
        app = initializeApp(firebaseConfig); 
        db = getFirestore(app); 
    } catch(e) {
        console.error("Firebase initialization error:", e);
        showPopup("Error", "Database connection failed!", "‚ùå");
    }

    let activeExam = null, currentIdx = 0, userAnswers = [], reviews = [], timerInterval, studentName = "", inputMode = 'json';
    
    // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßã‡¶® ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶ï‡ßç‡¶∞‡ßá‡¶°‡ßá‡¶®‡¶∂‡¶ø‡ßü‡¶æ‡¶≤ ‡¶®‡ßá‡¶á
    let appSettings = null;
    let currentAdmin = null; // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ó‡¶á‡¶®‡¶ï‡ßÉ‡¶§ ‡¶è‡¶°‡¶Æ‡¶ø‡¶®
    
    let allExamsData = [], categoryList = [], cheatCount = 0, remainingSeconds = 0, editingExamId = null;
    
    // Pagination Vars
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentFilteredExams = [];

    // Results Pagination Vars
    let allResultsData = [];
    let currentResultsPage = 1;
    const resultsPerPage = 20;

    // Simple hash function (for basic security - not for production)
    function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash.toString(36);
    }

    // MathJax ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    window.renderMathJax = function() {
        if (window.MathJax && MathJax.typeset) {
            setTimeout(() => {
                MathJax.typesetPromise().catch(err => {
                    console.log("MathJax render error:", err);
                });
            }, 50);
        }
    };

    async function initApp() {
        try {
            console.log("Initializing app...");
            
            // Check if settings exist
            const docRef = doc(db, "settings", "system");
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                // System already configured
                appSettings = docSnap.data();
                console.log("System settings loaded:", appSettings);
                
                // Show dashboard
                window.switchView('dashboard');
                
                // Load categories and exams
                loadCategoriesPublic();
                loadExams();
                
                // Load system stats
                loadSystemStats();
            } else {
                // First time setup needed
                console.log("System not configured, showing first setup");
                window.switchView('first-setup');
            }
        } catch(e) {
            console.error("Error initializing app:", e);
            showPopup("Error", "‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
        }
    }
    
    // Load system statistics
    async function loadSystemStats() {
        try {
            // Count exams
            const examsSnapshot = await getDocs(collection(db, "exams"));
            const examCount = examsSnapshot.size;
            
            // Count results
            const resultsSnapshot = await getDocs(collection(db, "results"));
            const resultCount = resultsSnapshot.size;
            
            // Update UI
            document.getElementById('total-exams').textContent = examCount;
            document.getElementById('total-results').textContent = resultCount;
        } catch(e) {
            console.error("Error loading stats:", e);
        }
    }
    
    // First time setup
    window.completeFirstSetup = async () => {
        const adminId = document.getElementById('setup-admin-id').value.trim();
        const adminPass = document.getElementById('setup-admin-pass').value.trim();
        const adminPassConfirm = document.getElementById('setup-admin-pass-confirm').value.trim();
        const reviewPass = document.getElementById('setup-review-pass').value.trim();
        const reviewPassConfirm = document.getElementById('setup-review-pass-confirm').value.trim();
        
        // Validation
        if (!adminId || !adminPass || !reviewPass) {
            showPopup("Error", "‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!", "‚ö†Ô∏è");
            return;
        }
        
        if (adminPass.length < 6) {
            showPopup("Error", "‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!", "‚ö†Ô∏è");
            return;
        }
        
        if (adminPass !== adminPassConfirm) {
            showPopup("Error", "‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ!", "‚ö†Ô∏è");
            return;
        }
        
        if (reviewPass !== reviewPassConfirm) {
            showPopup("Error", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ!", "‚ö†Ô∏è");
            return;
        }
        
        try {
            // Hash passwords
            const hashedAdminPass = simpleHash(adminPass);
            const hashedReviewPass = simpleHash(reviewPass);
            
            // Create settings document
            const settingsData = {
                adminId: adminId,
                adminPass: hashedAdminPass,
                reviewPass: hashedReviewPass,
                systemName: "Mr. Stylo Academy",
                defaultExamTime: 30,
                defaultPositiveMark: 1,
                defaultNegativeMark: 0.25,
                createdAt: Timestamp.now(),
                updatedAt: Timestamp.now()
            };
            
            await setDoc(doc(db, "settings", "system"), settingsData);
            
            // Also create an admin log
            await addDoc(collection(db, "admin_logs"), {
                action: "SYSTEM_SETUP",
                adminId: adminId,
                timestamp: Timestamp.now(),
                details: "System initialized for the first time"
            });
            
            showPopup("Success", "‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", "‚úÖ", () => {
                location.reload(); // Reload to apply settings
            });
            
        } catch(e) {
            console.error("Setup error:", e);
            showPopup("Error", "‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
        }
    };
    
    initApp();

    window.toggleFullScreen = () => { 
        if(document.documentElement.requestFullscreen) 
            document.documentElement.requestFullscreen().catch(()=>{}); 
    };
    window.enableProtect = () => { 
        window.onbeforeunload = function() { return "Exam running!"; }; 
    };
    window.disableProtect = () => { 
        window.onbeforeunload = null; 
    };

    window.showPopup = (t, m, i, ok, hideCancel = false) => {
        document.getElementById('pop-title').innerText = t; 
        document.getElementById('pop-msg').innerText = m; 
        document.getElementById('pop-icon').innerText = i;
        const c = document.getElementById('btn-pop-cancel');
        const o = document.getElementById('btn-pop-ok');
        c.style.display = hideCancel ? 'none' : 'block';
        o.style.width = hideCancel ? '100%' : 'auto';
        document.getElementById('custom-popup').classList.remove('hidden');
        o.onclick = () => { 
            document.getElementById('custom-popup').classList.add('hidden'); 
            if(ok) ok(); 
        };
        c.onclick = () => { 
            document.getElementById('custom-popup').classList.add('hidden'); 
        };
    };

    window.switchView = (v) => { 
        if(v === 'create-exam' && !editingExamId) resetCreateForm();
        document.querySelectorAll('.container > div').forEach(d => { 
            if(!d.id.includes('popup') && !d.id.includes('side')) d.classList.add('hidden'); 
            if(d.id === 'view-exam') d.classList.remove('exam-layout');
        }); 
        let t = document.getElementById('view-' + v); 
        t.classList.remove('hidden');
        if(v === 'exam') t.classList.add('exam-layout');
        
        // Load settings when admin settings view is opened
        if(v === 'admin-settings') {
            loadSettingsToForm();
        }
    };

    function resetCreateForm() {
        editingExamId = null;
        document.getElementById('new-title').value = "";
        document.getElementById('new-time').value = "";
        const sel = document.getElementById('new-category');
        if(sel.options.length > 0) sel.selectedIndex = 0;
        
        document.getElementById('mark-correct').value = "1";
        document.getElementById('mark-wrong').value = "0.25";
        document.getElementById('json-input').value = "";
        document.getElementById('questions-wrapper').innerHTML = "";
        document.getElementById('btn-publish').innerText = "üöÄ PUBLISH";
        document.getElementById('btn-publish').classList.remove('btn-save');
        document.getElementById('btn-publish').classList.add('btn-success');
    }

    window.togglePanel = (open) => {
        const p = document.getElementById('side-panel'), o = document.getElementById('side-overlay');
        if(open){ p.classList.add('open'); o.classList.add('active'); updatePalette(); }
        else{ p.classList.remove('open'); o.classList.remove('active'); }
    };

    // ================= CATEGORY & PAGINATION LOGIC =================

    async function loadCategoriesPublic() {
        categoryList = [];
        try {
            const s = await getDocs(query(collection(db, "categories"), orderBy("createdAt", "asc")));
            if(s.empty) categoryList = [{name: "General", id: "default"}];
            else s.forEach(d => categoryList.push({...d.data(), id: d.id}));
            renderCategories();
        } catch(e) { console.log("Cat error", e); }
    }

    function renderCategories() {
        const homeCont = document.getElementById('home-cat-container');
        let chipHtml = `<div onclick="filterExams('All')" class="cat-chip active" id="cat-all">All</div>`;
        const dropCont = document.getElementById('new-category');
        let dropHtml = ``;

        categoryList.forEach(c => {
            chipHtml += `<div onclick="filterExams('${c.name}')" class="cat-chip" id="cat-${c.name}">${c.name}</div>`;
            dropHtml += `<option value="${c.name}">${c.name}</option>`;
        });
        homeCont.innerHTML = chipHtml;
        dropCont.innerHTML = dropHtml;
    }

    window.loadCategoriesAdmin = async () => {
        window.switchView('categories');
        const listDiv = document.getElementById('admin-cat-list');
        listDiv.innerHTML = "Loading...";
        try {
            const s = await getDocs(query(collection(db, "categories"), orderBy("createdAt", "asc")));
            let h = "";
            s.forEach(d => {
                const c = d.data();
                h += `<div style="background:white; padding:10px; border-radius:8px; border:1px solid #eee; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span><b>${c.name}</b></span>
                    <button onclick="delCategory('${d.id}')" class="btn btn-danger" style="width:auto; padding:5px 12px; margin:0; font-size:0.8rem;">Delete</button>
                </div>`;
            });
            listDiv.innerHTML = h || "<p style='text-align:center;'>No categories found.</p>";
        } catch(e) { listDiv.innerHTML = "Error loading."; }
    };

    window.addCategory = async () => {
        const name = document.getElementById('new-cat-name').value.trim();
        if(!name) return showPopup("Error", "Enter Name!", "‚ö†Ô∏è");
        try {
            await addDoc(collection(db, "categories"), { 
                name: name, 
                createdAt: Timestamp.now(),
                createdBy: currentAdmin 
            });
            document.getElementById('new-cat-name').value = "";
            loadCategoriesAdmin(); 
            loadCategoriesPublic(); 
            showPopup("Success", "Category added!", "‚úÖ");
        } catch(e) { showPopup("Error", "Failed to add!", "‚ùå"); }
    };

    window.delCategory = (id) => {
        showPopup("Confirm", "Delete this category?", "üóëÔ∏è", async () => {
            await deleteDoc(doc(db, "categories", id));
            loadCategoriesAdmin(); 
            loadCategoriesPublic();
            showPopup("Success", "Category deleted!", "‚úÖ");
        });
    };

    // ================= EXAM LIST & PAGINATION =================

    window.loadExams = async () => { 
        const l = document.getElementById('exam-list'); 
        l.innerHTML = "<div style='text-align:center;'>‚è≥ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>"; 
        allExamsData = []; 
        try{ 
            const s = await getDocs(query(collection(db, "exams"), orderBy("createdAt", "desc"))); 
            s.forEach(d => { allExamsData.push({...d.data(), id: d.id}); });
            filterExams('All');
        } catch(e) {
            l.innerHTML = "Error loading exams.";
            console.error("Error loading exams:", e);
        } 
    };

    window.filterExams = (cat) => {
        document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
        let activeChip = document.getElementById('cat-' + (cat === 'All' ? 'all' : cat));
        if(activeChip) activeChip.classList.add('active');

        // Filter Logic
        if (cat === 'All') {
            currentFilteredExams = allExamsData;
        } else {
            currentFilteredExams = allExamsData.filter(e => (e.category || 'General') === cat);
        }
        
        // Reset to Page 1
        currentPage = 1;
        renderExamList();
    }

    window.renderExamList = () => {
        const l = document.getElementById('exam-list');
        const pControls = document.getElementById('pagination-controls');
        
        if (currentFilteredExams.length === 0) {
            l.innerHTML = "<p style='text-align:center;'>‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶®‡ßá‡¶á</p>"; 
            pControls.classList.add('hidden');
            return;
        }

        // Pagination Logic
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageItems = currentFilteredExams.slice(startIndex, endIndex);
        const totalPages = Math.ceil(currentFilteredExams.length / itemsPerPage);

        let html = "";
        pageItems.forEach((exam) => {
            let originalIndex = allExamsData.findIndex(e => e.id === exam.id);
            html += `<div style="background:white; padding:15px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee; box-shadow:0 2px 5px rgba(0,0,0,0.02);">
                <div>
                    <span style="font-size:0.7rem; background:#dfe6e9; padding:2px 8px; border-radius:10px; color:#636e72;">${exam.category || 'General'}</span>
                    <h3 style="margin:5px 0 0 0; font-size:1.1rem;">${exam.title}</h3>
                    <p style="margin:5px 0; color:#666; font-size:0.85rem;">‚è±Ô∏è ${exam.duration}m | ${exam.questions.length}Q</p>
                </div>
                <button onclick="showIntro(${originalIndex})" class="btn btn-primary" style="width:auto; padding:8px 20px; margin:0;">Start</button>
            </div>`; 
        });
        l.innerHTML = html;

        // Update Controls
        if (totalPages > 1) {
            pControls.classList.remove('hidden');
            document.getElementById('page-info').innerText = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('btn-prev').disabled = (currentPage === 1);
            document.getElementById('btn-next').disabled = (currentPage === totalPages);
        } else {
            pControls.classList.add('hidden');
        }
    }

    window.changePage = (dir) => {
        currentPage += dir;
        renderExamList();
    }

    window.showIntro = (idx) => { 
        activeExam = allExamsData[idx]; 
        window.switchView('intro'); 
        let pos = activeExam.marking ? activeExam.marking.correct : 1;
        document.getElementById('intro-title').innerText = activeExam.title; 
        document.getElementById('intro-time').innerText = activeExam.duration; 
        document.getElementById('intro-q').innerText = activeExam.questions.length; 
        document.getElementById('intro-cat-badge').innerText = activeExam.category || "General";
        document.getElementById('intro-total-marks').innerText = activeExam.questions.length * pos;
        document.getElementById('intro-neg').innerText = activeExam.marking ? activeExam.marking.wrong : 0.25;
    };

    window.startRealExam = () => { 
        studentName = document.getElementById('student-name-input').value.trim(); 
        if(!studentName) return showPopup("Alert", "‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!", "‚úçÔ∏è"); 
        
        toggleFullScreen(); 
        enableProtect();
        activeExam.questions = activeExam.questions.sort(() => Math.random() - 0.5);
        userAnswers = new Array(activeExam.questions.length).fill(null); 
        reviews = new Array(activeExam.questions.length).fill(false);
        currentIdx = 0; 
        cheatCount = 0;
        document.getElementById('display-name').innerText = studentName; 
        document.getElementById('q-pos').innerText = activeExam.marking ? activeExam.marking.correct : 1;
        document.getElementById('q-neg').innerText = activeExam.marking ? activeExam.marking.wrong : 0.25;
        window.switchView('exam'); 
        generatePalette(); 
        loadQuestion(); 
        startTimer(activeExam.duration * 60); 
        document.addEventListener("visibilitychange", handleCheat); 
    };

    function generatePalette() {
        let html = ""; 
        for(let i = 0; i < activeExam.questions.length; i++) {
            let classes = "palette-btn";
            if(i === currentIdx) classes += " active";
            if(userAnswers[i] !== null && userAnswers[i] !== undefined) classes += " answered";
            if(reviews[i]) classes += " review";
            html += `<div onclick="jumpToQ(${i})" id="pal-${i}" class="${classes}">${i+1}</div>`;
        }
        document.getElementById('palette-grid').innerHTML = html;
    }
    
    window.jumpToQ = (idx) => { 
        currentIdx = idx; 
        loadQuestion(); 
        togglePanel(false); 
    };

    function loadQuestion() { 
        const q = activeExam.questions[currentIdx]; 
        
        // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (MathJax ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶π)
        document.getElementById('q-text').innerHTML = `Q${currentIdx+1}. ${q.q}`; 
        document.getElementById('q-topic-badge').innerText = q.topic || "General";
        
        // ‡¶á‡¶Æ‡ßá‡¶ú
        const img = document.getElementById('q-image');
        if(q.image) { 
            img.src = q.image; 
            img.style.display = 'block'; 
        } else { 
            img.style.display = 'none'; 
        }
        
        // ‡¶Ö‡¶™‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã
        let h = ""; 
        q.options.forEach(o => { 
            h += `<div onclick="selOpt('${o}')" class="option-btn ${userAnswers[currentIdx] === o ? 'selected' : ''} math-content">${o}</div>`; 
        }); 
        document.getElementById('options-container').innerHTML = h; 
        
        // MathJax ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        setTimeout(renderMathJax, 100);
        updatePalette();
    }

    // ‡¶™‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function updatePalette() {
        document.querySelectorAll('.palette-btn').forEach((b,i) => {
            let classes = "palette-btn";
            if(i === currentIdx) classes += " active";
            if(userAnswers[i] !== null && userAnswers[i] !== undefined) classes += " answered";
            if(reviews[i]) classes += " review";
            b.className = classes;
        });
    }

    window.selOpt = (o) => { 
        userAnswers[currentIdx] = o; 
        loadQuestion(); 
    };
    
    window.markAndNext = () => { 
        reviews[currentIdx] = true; 
        window.nextQ(); 
    };
    
    window.clearResponse = () => { 
        userAnswers[currentIdx] = null; 
        reviews[currentIdx] = false; 
        loadQuestion(); 
    };
    
    window.saveAndNext = () => { 
        if(userAnswers[currentIdx]) reviews[currentIdx] = false; 
        window.nextQ(); 
    };
    
    window.prevQ = () => { 
        if(currentIdx > 0) { 
            currentIdx--; 
            loadQuestion(); 
        } else { 
            showPopup("Info", "‡¶è‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®!", "‚ÑπÔ∏è"); 
        } 
    };
    
    window.nextQ = () => { 
        if(currentIdx < activeExam.questions.length - 1) { 
            currentIdx++; 
            loadQuestion(); 
        } else { 
            showPopup("End", "‡¶∂‡ßá‡¶∑ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®! ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "üèÅ", () => togglePanel(true)); 
        } 
    };
    
    window.confirmSubmit = () => { 
        showPopup("Submit?", "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?", "üöÄ", window.submitExam); 
    };

    function handleCheat() {
        if(document.hidden) {
            cheatCount++;
            if(cheatCount >= 3) showPopup("Violation", "‡ß© ‡¶¨‡¶æ‡¶∞ ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶∂‡ßá‡¶∑! ‡¶Ö‡¶ü‡ßã ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü‡•§", "üö´", window.submitExam, true);
            else showPopup("Warning", `‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ! ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç: ${cheatCount}/3`, "‚ö†Ô∏è", null, true);
        }
    }

    window.submitExam = async() => { 
        togglePanel(false); 
        disableProtect(); 
        clearInterval(timerInterval); 
        document.removeEventListener("visibilitychange", handleCheat); 
        
        let score = 0, correct = 0, wrong = 0;
        let pos = activeExam.marking ? activeExam.marking.correct : 1;
        let neg = activeExam.marking ? activeExam.marking.wrong : 0.25;
        let topicStats = {};
        
        activeExam.questions.forEach((q, i) => { 
            let t = q.topic || "Others"; 
            if(!topicStats[t]) topicStats[t] = { total: 0, correct: 0 }; 
            topicStats[t].total++;
            
            if(userAnswers[i] === q.answer) { 
                score += parseFloat(pos); 
                correct++; 
                topicStats[t].correct++; 
            } else if(userAnswers[i]) { 
                score -= parseFloat(neg); 
                wrong++; 
            }
        });
        
        if(score < 0) score = 0;
        
        let totalSec = activeExam.duration * 60; 
        let taken = totalSec - remainingSeconds;
        let mm = Math.floor(taken / 60);
        let ss = taken % 60;
        let percent = (score / (activeExam.questions.length * pos)) * 100;
        
        let th = "";
        for(let t in topicStats) {
            let p = (topicStats[t].correct / topicStats[t].total) * 100;
            let c = p >= 80 ? '#00b894' : (p >= 40 ? '#fdcb6e' : '#d63031');
            th += `<div style="margin-bottom:8px;">
                <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                    <span>${t}</span><span>${Math.round(p)}%</span>
                </div>
                <div style="width:100%; background:#f1f2f6; height:6px; border-radius:10px;">
                    <div style="height:100%; border-radius:10px; width:${p}%; background:${c};"></div>
                </div>
            </div>`;
        }
        
        window.switchView('result'); 
        document.getElementById('res-score').innerText = score.toFixed(2); 
        document.getElementById('res-percent').innerText = percent.toFixed(1) + "%"; 
        document.getElementById('res-grade').innerText = percent >= 80 ? "A+" : percent >= 60 ? "A" : percent >= 40 ? "B" : "F";
        document.getElementById('res-time').innerText = `${mm}m ${ss}s`;
        document.getElementById('res-correct').innerText = correct;
        document.getElementById('res-wrong').innerText = wrong;
        document.getElementById('topic-analysis-container').innerHTML = th;
        
        try { 
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); 
        } catch(e) {}
        
        try { 
            await addDoc(collection(db, "results"), {
                name: studentName, 
                exam: activeExam.title, 
                examId: activeExam.id,
                score: score.toFixed(2), 
                percent: percent.toFixed(1), 
                correct: correct,
                wrong: wrong,
                total: activeExam.questions.length,
                createdAt: Timestamp.now()
            }); 
            
            // Update exam stats
            const examRef = doc(db, "exams", activeExam.id);
            await updateDoc(examRef, {
                attempts: increment(1)
            });
            
        } catch(e) {
            console.error("Error saving result:", e);
        }
    };

    // ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function startTimer(s) { 
        remainingSeconds = s; 
        clearInterval(timerInterval); 
        
        // Immediate update
        updateTimerDisplay();
        
        timerInterval = setInterval(() => { 
            if (remainingSeconds <= 0) { 
                clearInterval(timerInterval); 
                showPopup("Time Up", "‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑!", "‚åõ", window.submitExam, true); 
                return;
            } 
            remainingSeconds--;
            updateTimerDisplay();
        }, 1000); 
        
        function updateTimerDisplay() {
            let m = Math.floor(remainingSeconds / 60);
            let sc = remainingSeconds % 60;
            document.getElementById('timer').innerText = `${m}:${sc < 10 ? '0' : ''}${sc}`;
        }
    }

    // ================= ADMIN FUNCTIONS - SECURE =================

    // Admin ‡¶≤‡¶ó‡¶á‡¶® ‡¶ö‡ßá‡¶ï
    window.checkAdmin = async () => { 
        const adminId = document.getElementById('admin-id').value.trim();
        const adminPass = document.getElementById('admin-pass').value.trim();
        
        if(!adminId || !adminPass) {
            showPopup("Error", "‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!", "‚ö†Ô∏è");
            return;
        }
        
        try {
            // Load settings
            const docRef = doc(db, "settings", "system");
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                showPopup("Error", "‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
                return;
            }
            
            const settings = docSnap.data();
            const hashedInput = simpleHash(adminPass);
            
            // Check credentials
            if(adminId === settings.adminId && hashedInput === settings.adminPass) {
                // Login successful
                currentAdmin = adminId;
                
                // Clear fields
                document.getElementById('admin-id').value = "";
                document.getElementById('admin-pass').value = "";
                
                // Update UI
                document.getElementById('logged-admin').textContent = adminId;
                
                // Log the login
                await addDoc(collection(db, "admin_logs"), {
                    action: "ADMIN_LOGIN",
                    adminId: adminId,
                    timestamp: Timestamp.now(),
                    ip: "web-app" // In real app, get user IP
                });
                
                // Load admin menu
                window.switchView('admin-menu');
                loadSystemStats();
                
                showPopup("Success", "‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤!", "‚úÖ", null, true);
            } else {
                showPopup("Error", "‡¶≠‡ßÅ‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!", "‚ùå");
                
                // Log failed attempt
                await addDoc(collection(db, "failed_logins"), {
                    attemptId: adminId,
                    timestamp: Timestamp.now(),
                    type: "ADMIN"
                });
            }
        } catch(e) {
            console.error("Login error:", e);
            showPopup("Error", "‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
        }
    };

    // Admin logout
    window.adminLogout = () => {
        showPopup("Confirm", "‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?", "üö™", () => {
            currentAdmin = null;
            window.switchView('dashboard');
            showPopup("Success", "‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶∏‡¶´‡¶≤!", "‚úÖ", null, true);
        });
    };

    // Change admin password from settings page
    window.changeAdminPasswordFromSettings = async () => {
        const newPass = document.getElementById('admin-new-password').value.trim();
        const confirmPass = document.getElementById('admin-new-password-confirm').value.trim();
        
        if(!newPass || !confirmPass) {
            showPopup("Error", "‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!", "‚ö†Ô∏è");
            return;
        }
        
        if(newPass.length < 6) {
            showPopup("Error", "‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!", "‚ö†Ô∏è");
            return;
        }
        
        if(newPass !== confirmPass) {
            showPopup("Error", "‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ!", "‚ö†Ô∏è");
            return;
        }
        
        try {
            const docRef = doc(db, "settings", "system");
            
            // Update password
            const hashedNew = simpleHash(newPass);
            await updateDoc(docRef, {
                adminPass: hashedNew,
                updatedAt: Timestamp.now(),
                lastPasswordChange: Timestamp.now()
            });
            
            // Clear fields
            document.getElementById('admin-new-password').value = "";
            document.getElementById('admin-new-password-confirm').value = "";
            
            // Log the change
            await addDoc(collection(db, "admin_logs"), {
                action: "ADMIN_PASSWORD_CHANGE_FROM_SETTINGS",
                adminId: currentAdmin,
                timestamp: Timestamp.now()
            });
            
            showPopup("Success", "‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", "‚úÖ");
            
        } catch(e) {
            console.error("Admin password change error:", e);
            showPopup("Error", "‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
        }
    };

    // Change review password
    window.changeReviewPassword = async () => {
        const newPass = document.getElementById('review-new-password').value.trim();
        const confirmPass = document.getElementById('review-new-password-confirm').value.trim();
        
        if(!newPass || !confirmPass) {
            showPopup("Error", "‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!", "‚ö†Ô∏è");
            return;
        }
        
        if(newPass !== confirmPass) {
            showPopup("Error", "‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ!", "‚ö†Ô∏è");
            return;
        }
        
        try {
            const docRef = doc(db, "settings", "system");
            
            // Update password
            const hashedNew = simpleHash(newPass);
            await updateDoc(docRef, {
                reviewPass: hashedNew,
                updatedAt: Timestamp.now(),
                lastReviewPasswordChange: Timestamp.now()
            });
            
            // Clear fields
            document.getElementById('review-new-password').value = "";
            document.getElementById('review-new-password-confirm').value = "";
            
            // Log the change
            await addDoc(collection(db, "admin_logs"), {
                action: "REVIEW_PASSWORD_CHANGE",
                adminId: currentAdmin,
                timestamp: Timestamp.now()
            });
            
            showPopup("Success", "‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", "‚úÖ");
            
        } catch(e) {
            console.error("Review password change error:", e);
            showPopup("Error", "‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
        }
    };

    // Change admin password from dedicated page
    window.changeAdminPassword = async () => {
        const currentPass = document.getElementById('current-password').value.trim();
        const newPass = document.getElementById('new-password').value.trim();
        const confirmPass = document.getElementById('confirm-password').value.trim();
        
        if(!currentPass || !newPass || !confirmPass) {
            showPopup("Error", "‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!", "‚ö†Ô∏è");
            return;
        }
        
        if(newPass.length < 6) {
            showPopup("Error", "‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!", "‚ö†Ô∏è");
            return;
        }
        
        if(newPass !== confirmPass) {
            showPopup("Error", "‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ!", "‚ö†Ô∏è");
            return;
        }
        
        try {
            // Load current settings
            const docRef = doc(db, "settings", "system");
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                showPopup("Error", "‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
                return;
            }
            
            const settings = docSnap.data();
            const hashedCurrent = simpleHash(currentPass);
            
            // Verify current password
            if(hashedCurrent !== settings.adminPass) {
                showPopup("Error", "‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤!", "‚ùå");
                return;
            }
            
            // Update password
            const hashedNew = simpleHash(newPass);
            await updateDoc(docRef, {
                adminPass: hashedNew,
                updatedAt: Timestamp.now(),
                lastPasswordChange: Timestamp.now()
            });
            
            // Clear fields
            document.getElementById('current-password').value = "";
            document.getElementById('new-password').value = "";
            document.getElementById('confirm-password').value = "";
            
            // Log the change
            await addDoc(collection(db, "admin_logs"), {
                action: "PASSWORD_CHANGE",
                adminId: currentAdmin,
                timestamp: Timestamp.now()
            });
            
            showPopup("Success", "‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", "‚úÖ", () => {
                window.switchView('admin-menu');
            });
            
        } catch(e) {
            console.error("Password change error:", e);
            showPopup("Error", "‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
        }
    };

    // Load settings to form
    async function loadSettingsToForm() {
        try {
            const docRef = doc(db, "settings", "system");
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const settings = docSnap.data();
                
                // Fill form fields
                document.getElementById('system-name').value = settings.systemName || "Mr. Stylo Academy";
                document.getElementById('default-exam-time').value = settings.defaultExamTime || 30;
                document.getElementById('default-positive-mark').value = settings.defaultPositiveMark || 1;
                document.getElementById('default-negative-mark').value = settings.defaultNegativeMark || 0.25;
            }
        } catch(e) {
            console.error("Error loading settings:", e);
        }
    }

    // Save system settings
    window.saveSystemSettings = async () => {
        try {
            const docRef = doc(db, "settings", "system");
            const systemName = document.getElementById('system-name').value.trim() || "Mr. Stylo Academy";
            const defaultTime = parseInt(document.getElementById('default-exam-time').value) || 30;
            const defaultPos = parseFloat(document.getElementById('default-positive-mark').value) || 1;
            const defaultNeg = parseFloat(document.getElementById('default-negative-mark').value) || 0.25;
            
            await updateDoc(docRef, {
                systemName: systemName,
                defaultExamTime: defaultTime,
                defaultPositiveMark: defaultPos,
                defaultNegativeMark: defaultNeg,
                updatedAt: Timestamp.now()
            });
            
            showPopup("Success", "‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!", "‚úÖ", () => {
                window.switchView('admin-menu');
            });
            
        } catch(e) {
            console.error("Settings save error:", e);
            showPopup("Error", "‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
        }
    };

    // Review ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶ï
    window.checkReviewPass = async () => { 
        const reviewPass = document.getElementById('review-pass').value.trim();
        if(!reviewPass) {
            showPopup("Error", "‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!", "‚ö†Ô∏è");
            return;
        }
        
        try {
            const docRef = doc(db, "settings", "system");
            const docSnap = await getDoc(docRef);
            
            if (!docSnap.exists()) {
                showPopup("Error", "‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
                return;
            }
            
            const settings = docSnap.data();
            const hashedInput = simpleHash(reviewPass);
            
            if(hashedInput === settings.reviewPass) {
                document.getElementById('review-pass').value = "";
                window.showReview();
            } else {
                showPopup("Error", "‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!", "‚ùå");
            }
        } catch(e) {
            console.error("Review pass check error:", e);
            showPopup("Error", "‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!", "‚ùå");
        }
    };

    // ================= OTHER ADMIN FUNCTIONS =================
    
    window.toggleInputMode = (m) => { 
        inputMode = m; 
        document.getElementById('mode-json').classList.toggle('hidden', m !== 'json'); 
        document.getElementById('mode-manual').classList.toggle('hidden', m !== 'manual'); 
        if(m === 'manual' && document.getElementById('questions-wrapper').children.length === 0) 
            window.addQuestionField(); 
    };
    
    window.addQuestionField = () => {
        const id = Date.now();
        const h = `<div class="exam-card" id="q-${id}" style="background:#f9f9f9; padding:10px; border:1px solid #ddd; margin-bottom:10px; border-radius:8px;">
            <input type="text" class="inp-q" placeholder="Question..." style="margin-bottom:5px; width:100%; padding:8px;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:5px;">
                <input type="text" class="inp-topic" placeholder="Topic">
                <input type="text" class="inp-img" placeholder="Img URL">
            </div>
            <div id="opts-${id}">
                ${getOpt(id,1)}
                ${getOpt(id,2)}
                ${getOpt(id,3)}
                ${getOpt(id,4)}
            </div>
            <!-- Explanation field -->
            <textarea class="inp-exp" placeholder="‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ (Explanation) - MathJax ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶°: $E=mc^2$..." 
                      style="width:100%; height:60px; padding:8px; border:1px solid #ddd; border-radius:5px; margin-top:5px; font-size:0.9rem;"></textarea>
            <button onclick="document.getElementById('q-${id}').remove()" class="btn btn-danger" style="padding:5px; width:auto; font-size:0.8rem; margin-top:5px;">Delete</button>
        </div>`;
        document.getElementById('questions-wrapper').insertAdjacentHTML('beforeend', h);
    };
    
    function getOpt(id, n) { 
        return `<div style="display:flex; gap:5px; margin-bottom:5px;">
            <input type="radio" name="ans-${id}" value="${n-1}">
            <input type="text" class="inp-opt" placeholder="Option ${n}" style="padding:8px;">
        </div>`; 
    }

    document.getElementById('btn-publish').addEventListener('click', async () => {
        if (!currentAdmin) {
            showPopup("Error", "‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®!", "üîí");
            window.switchView('admin-login');
            return;
        }
        
        const t = document.getElementById('new-title').value.trim(); 
        const cat = document.getElementById('new-category').value; 
        let q = [];
        
        if(inputMode === 'json') { 
            try { 
                let j = JSON.parse(document.getElementById('json-input').value); 
                q = Array.isArray(j) ? j : (j.questions || []); 
            } catch(e) { 
                return showPopup("Error", "JSON ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≠‡ßÅ‡¶≤!", "‚ö†Ô∏è"); 
            } 
        } else {
            document.querySelectorAll('#questions-wrapper .exam-card').forEach(c => {
                let qt = c.querySelector('.inp-q').value.trim();
                let ops = [];
                let ans = null;
                
                c.querySelectorAll('.inp-opt').forEach((o, i) => { 
                    if(o.value.trim()) { 
                        ops.push(o.value.trim()); 
                        if(o.parentElement.querySelector('input[type="radio"]').checked) 
                            ans = o.value.trim(); 
                    } 
                });
                
                let exp = c.querySelector('.inp-exp').value.trim() || null;
                
                if(qt && ops.length > 1 && ans) {
                    q.push({
                        q: qt, 
                        options: ops, 
                        answer: ans, 
                        topic: c.querySelector('.inp-topic').value.trim() || "General", 
                        image: c.querySelector('.inp-img').value.trim() || null, 
                        explanation: exp
                    });
                }
            });
        }
        
        if(!t || q.length === 0) return showPopup("Error", "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¶‡¶ø‡¶®!", "‚ö†Ô∏è");
        
        const payload = {
            title: t, 
            duration: parseInt(document.getElementById('new-time').value) || 30, 
            category: cat, 
            questions: q, 
            marking: { 
                correct: parseFloat(document.getElementById('mark-correct').value) || 1, 
                wrong: parseFloat(document.getElementById('mark-wrong').value) || 0.25 
            }, 
            createdBy: currentAdmin,
            attempts: 0,
            createdAt: Timestamp.now()
        };

        try { 
            if(editingExamId) {
                await setDoc(doc(db, "exams", editingExamId), payload);
                showPopup("Success", "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "‚úÖ", () => { 
                    editingExamId = null; 
                    window.switchView('admin-menu'); 
                });
            } else {
                await addDoc(collection(db, "exams"), payload); 
                showPopup("Success", "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "‚úÖ", () => window.switchView('admin-menu')); 
            }
        } catch(e) { 
            console.error("Error publishing exam:", e);
            showPopup("Error", "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "‚ùå"); 
        }
    });

    window.editExam = async (id) => {
        if (!currentAdmin) {
            showPopup("Error", "‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®!", "üîí");
            window.switchView('admin-login');
            return;
        }
        
        showPopup("Loading", "‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "‚è≥", null, true);
        try {
            const docSnap = await getDoc(doc(db, "exams", id));
            if(docSnap.exists()) {
                const d = docSnap.data();
                editingExamId = id;
                document.getElementById('new-title').value = d.title;
                document.getElementById('new-time').value = d.duration;
                document.getElementById('new-category').value = d.category || 'General';
                
                if(d.marking) { 
                    document.getElementById('mark-correct').value = d.marking.correct; 
                    document.getElementById('mark-wrong').value = d.marking.wrong; 
                }
                
                window.toggleInputMode('json');
                document.getElementById('json-input').value = JSON.stringify(d.questions, null, 4);
                
                const btn = document.getElementById('btn-publish');
                btn.innerText = "üîÑ UPDATE EXAM";
                btn.classList.remove('btn-success');
                btn.classList.add('btn-save');
                
                document.getElementById('custom-popup').classList.add('hidden');
                window.switchView('create-exam');
            }
        } catch(e) { 
            showPopup("Error", "‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!", "‚ùå"); 
        }
    };

    window.loadManageExams = async () => { 
        if (!currentAdmin) {
            showPopup("Error", "‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®!", "üîí");
            window.switchView('admin-login');
            return;
        }
        
        window.switchView('manage-exams'); 
        document.getElementById('manage-exam-list').innerHTML = "Loading..."; 
        try {
            const s = await getDocs(query(collection(db, "exams"), orderBy("createdAt", "desc"))); 
            let h = ""; 
            s.forEach(d => {
                const data = d.data();
                h += `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee; gap:10px;">
                    <span style="flex:1;">${data.title} <small style="color:#666">(${data.category || 'Gen'})</small></span>
                    <span style="font-size:0.8rem; color:#666;">${data.attempts || 0} attempts</span>
                    <button onclick="editExam('${d.id}')" class="btn btn-primary" style="width:auto; padding:5px 12px; margin:0; font-size:0.8rem;">Edit</button>
                    <button onclick="delExam('${d.id}')" class="btn btn-danger" style="width:auto; padding:5px 12px; margin:0; font-size:0.8rem;">Del</button>
                </div>`;
            }); 
            document.getElementById('manage-exam-list').innerHTML = h || "No Exams"; 
        } catch(e) {
            document.getElementById('manage-exam-list').innerHTML = "Error loading exams.";
        }
    };

    window.delExam = (id) => { 
        if (!currentAdmin) {
            showPopup("Error", "‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®!", "üîí");
            window.switchView('admin-login');
            return;
        }
        
        showPopup("Delete?", "‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?", "üóëÔ∏è", async () => { 
            try {
                await deleteDoc(doc(db, "exams", id)); 
                loadManageExams();
                showPopup("Success", "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "‚úÖ");
            } catch(e) {
                showPopup("Error", "‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "‚ùå");
            }
        }); 
    };

    window.showReview = () => { 
        let h = ""; 
        document.getElementById('review-student-name').innerText = studentName; 
        
        activeExam.questions.forEach((q, i) => { 
            let s = (userAnswers[i] === q.answer) ? "correct" : (userAnswers[i] ? "wrong" : "skipped");
            let c = s === "correct" ? "#00b894" : (s === "wrong" ? "#d63031" : "#636e72");
            
            h += `<div class="review-item ${s}" style="background:white; padding:15px; margin-bottom:10px; border-left:4px solid ${c}; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <p style="margin:0 0 5px 0;"><b>Q${i+1}. ${q.q}</b></p>
                <div style="margin:10px 0; padding:10px; background:#f8f9fa; border-radius:5px;">
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:5px;">
                        ${q.options.map((opt, idx) => `
                            <div style="padding:5px; border-radius:3px; background:${opt === q.answer ? '#d4edda' : (userAnswers[i] === opt ? '#f8d7da' : '#f1f2f6')}">
                                ${String.fromCharCode(65 + idx)}. ${opt}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <p style="font-size:0.85rem; color:#666;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞: <b style="color:${c}">${userAnswers[i] || 'Skipped'}</b> | ‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞: <b style="color:#00b894">${q.answer}</b></p>
                <div style="background:#eef2ff; padding:10px; font-size:0.85rem; margin-top:8px; border-radius:5px; border-left:3px solid #6c5ce7;">
                    <strong style="color:#6c5ce7;">üí° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ:</strong><br>
                    <div class="math-content">${q.explanation || '‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶®‡ßá‡¶á‡•§'}</div>
                </div>
            </div>`; 
        }); 
        
        document.getElementById('review-list').innerHTML = h; 
        window.switchView('review'); 
        
        // MathJax ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        setTimeout(renderMathJax, 300);
    };
    
    window.filterReview = (t) => { 
        document.querySelectorAll('.review-item').forEach(i => { 
            i.style.display = (t === 'all' || i.classList.contains(t)) ? 'block' : 'none'; 
        }); 
    };
    
    // ================= ADMIN RESULTS WITH PAGINATION =================
    
    window.loadAdminResults = async () => { 
        if (!currentAdmin) {
            showPopup("Error", "‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®!", "üîí");
            window.switchView('admin-login');
            return;
        }
        
        window.switchView('admin-results'); 
        document.getElementById('result-table-body').innerHTML = "Loading..."; 
        document.getElementById('result-pagination').classList.add('hidden');
        
        try {
            const s = await getDocs(query(collection(db, "results"), orderBy("createdAt", "desc"))); 
            allResultsData = [];
            s.forEach(d => {
                allResultsData.push({...d.data(), id: d.id});
            });
            
            // Reset to page 1
            currentResultsPage = 1;
            renderResultsList();
        } catch(e) {
            document.getElementById('result-table-body').innerHTML = "<tr><td colspan='5'>Error loading results</td></tr>";
        }
    };

    function renderResultsList() {
        const tbody = document.getElementById('result-table-body');
        const pControls = document.getElementById('result-pagination');
        
        if (allResultsData.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5'>No Data</td></tr>";
            pControls.classList.add('hidden');
            return;
        }

        // Pagination Logic
        const startIndex = (currentResultsPage - 1) * resultsPerPage;
        const endIndex = startIndex + resultsPerPage;
        const pageItems = allResultsData.slice(startIndex, endIndex);
        const totalPages = Math.ceil(allResultsData.length / resultsPerPage);

        let h = ""; 
        pageItems.forEach((v) => {
            h += `<tr style="border-bottom:1px solid #eee;">
                <td>${v.name}</td>
                <td>${v.exam}</td>
                <td>${v.score}</td>
                <td>${v.percent}%</td>
                <td>${v.correct}/${v.total}</td>
            </tr>`;
        });
        
        tbody.innerHTML = h;

        // Update Pagination Controls
        if (totalPages > 1) {
            pControls.classList.remove('hidden');
            document.getElementById('results-page-info').innerText = `Page ${currentResultsPage} of ${totalPages}`;
            document.getElementById('btn-results-prev').disabled = (currentResultsPage === 1);
            document.getElementById('btn-results-next').disabled = (currentResultsPage === totalPages);
        } else {
            pControls.classList.add('hidden');
        }
    }

    window.changeResultPage = (dir) => {
        currentResultsPage += dir;
        renderResultsList();
    };
    
    window.loadLeaderboard = async () => { 
        window.switchView('leaderboard'); 
        document.getElementById('lb-exam-name').innerText = activeExam.title; 
        document.getElementById('lb-list').innerHTML = "Loading..."; 
        try {
            const s = await getDocs(query(collection(db, "results"), orderBy("score", "desc"))); 
            let h = "<table style='width:100%; font-size:0.9rem; border-collapse:collapse;'><tr style='background:#f8f9fa;'><th style='padding:10px; text-align:center;'>Rank</th><th style='padding:10px;'>Name</th><th style='padding:10px; text-align:center;'>Score</th><th style='padding:10px; text-align:center;'>%</th></tr>"; 
            let r = 1; 
            s.forEach(d => {
                let v = d.data(); 
                if(v.examId === activeExam.id) { 
                    h += `<tr style='border-bottom:1px solid #eee;'>
                        <td style="text-align:center; padding:8px;">${r}</td>
                        <td style="padding:8px;">${v.name}</td>
                        <td style="text-align:center; padding:8px; font-weight:bold; color:#6c5ce7;">${v.score}</td>
                        <td style="text-align:center; padding:8px;">${v.percent}%</td>
                    </tr>`; 
                    r++; 
                } 
            }); 
            document.getElementById('lb-list').innerHTML = r > 1 ? h + "</table>" : "<p style='text-align:center;'>No data available</p>"; 
        } catch(e) {
            document.getElementById('lb-list').innerHTML = "<p style='text-align:center;'>Error loading leaderboard</p>";
        }
    };
    
    window.shareExam = () => { 
        if(navigator.share) {
            navigator.share({
                title: activeExam.title, 
                text: `Scored ${document.getElementById('res-score').innerText} in ${activeExam.title}!`, 
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(`Scored ${document.getElementById('res-score').innerText} in ${activeExam.title}!`);
            alert("Result copied to clipboard!");
        }
    };

</script>
</body>
</html>