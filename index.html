<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mr. Stylo Academy | Premium Mock Test</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== THEME VARIABLES ==================== */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: #ffffff;
            --font-main: 'Noto Serif Bengali', serif;
            --font-num: 'Poppins', sans-serif;
            --color-primary: #6c5ce7;
            --color-danger: #d63031;
            --color-success: #00b894;
        }

        /* ==================== BASE STYLES ==================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; padding: 0; 
            background: #dfe6e9; 
            font-family: var(--font-main); 
            color: #2d3436;
            height: 100vh; height: 100dvh;
            display: flex; justify-content: center;
            overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }

        input, textarea, select { -webkit-user-select: text; user-select: text; }

        .container { 
            width: 100%; max-width: 550px; 
            background: var(--glass-bg); 
            height: 100%; position: relative; 
            display: flex; flex-direction: column; 
            z-index: 10; overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Utility */
        .hidden { display: none !important; }
        .p-20 { padding: 20px; }
        .font-num { font-family: var(--font-num); }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        /* ==================== BUTTONS & CHIPS ==================== */
        .btn { 
            width: 100%; padding: 12px; border: none; border-radius: 8px; 
            font-weight: 600; cursor: pointer; margin-top: 10px; 
            font-size: 0.95rem; transition: transform 0.1s; 
            font-family: var(--font-main); 
            display: flex; justify-content: center; align-items: center;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 3px 8px rgba(108, 92, 231, 0.3); }
        .btn-danger { background: #ff7675; color: white; }
        .btn-outline { background: white; border: 1.5px solid #dfe6e9; color: #636e72; }
        .btn-save { background: linear-gradient(135deg, #0984e3, #6c5ce7); color: white; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3); border:none; }

        /* Category Chips */
        .cat-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .cat-scroll::-webkit-scrollbar { display: none; }
        .cat-chip {
            padding: 5px 12px; background: white; border: 1px solid #dfe6e9;
            border-radius: 20px; white-space: nowrap; font-size: 0.8rem;
            color: #636e72; cursor: pointer; transition: 0.2s;
        }
        .cat-chip.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }

        /* Pagination Controls */
        .pagination-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .page-btn { padding: 8px 15px; background: white; border: 1px solid #dfe6e9; border-radius: 8px; cursor: pointer; font-size: 0.8rem; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 0.8rem; color: #636e72; }

        /* ==================== EXAM VIEW CSS ==================== */
        .exam-layout { display: flex; flex-direction: column; height: 100%; }
        
        .exam-header { 
            background: white; padding: 10px 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #f1f2f6; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            z-index: 20; height: 50px;
        }
        
        .timer-badge { 
            background: #d63031; color: white; padding: 4px 10px; 
            border-radius: 20px; font-weight: bold; font-family: var(--font-num); font-size: 0.85rem;
        }

        .scroll-area { 
            flex: 1; overflow-y: auto; padding: 20px; 
            background: #f8f9fa; -webkit-overflow-scrolling: touch; 
        }

        .question-card { margin-bottom: 20px; }
        #q-text { font-size: 1.05rem; line-height: 1.5; color: #2d3436; margin: 0 0 12px 0; font-weight: 600; }
        
        .option-btn { 
            background: white; border: 1.5px solid #e0e0e0; 
            padding: 12px; border-radius: 10px; margin-bottom: 8px; 
            cursor: pointer; width: 100%; text-align: left; 
            transition: 0.2s; font-size: 0.95rem; color: #555;
            position: relative;
        }
        .option-btn.selected { background: #eef2ff; border-color: #6c5ce7; color: #6c5ce7; font-weight: 600; }

        /* Footer Bar (Exam) */
        .footer-bar { 
            padding: 8px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
            background: white; border-top: 1px solid #f1f2f6; 
            display: flex; gap: 8px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 30;
        }
        .footer-btn { flex: 1; padding: 8px 2px; margin: 0; font-size: 0.8rem; border-radius: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .btn-save { flex: 1.2; }

        /* App Footer (Dashboard) */
        .app-footer {
            text-align: center; padding: 20px; color: #b2bec3; 
            font-size: 0.75rem; border-top: 1px solid #f1f2f6;
            margin-top: auto; background: #fdfdfd;
        }

        /* ==================== SIDE PANEL ==================== */
        .side-panel { 
            position: absolute; top: 0; right: -100%; width: 80%; max-width: 300px; 
            height: 100%; background: white; z-index: 2000; 
            box-shadow: -10px 0 30px rgba(0,0,0,0.2); 
            transition: right 0.3s ease; display: flex; flex-direction: column; 
        }
        .side-panel.open { right: 0; }
        .overlay-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1900; display: none; }
        .overlay-bg.active { display: block; }
        
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 15px; overflow-y: auto; }
        .palette-btn { 
            height: 35px; border-radius: 6px; border: 1px solid #eee; background: #f9f9f9; 
            display: flex; justify-content: center; align-items: center; 
            font-weight: 600; cursor: pointer; font-family: var(--font-num); color: #636e72; font-size: 0.9rem;
        }
        .palette-btn.active { border: 1.5px solid #6c5ce7; background: white; color: #6c5ce7; } 
        .palette-btn.answered { background: #00b894; color: white; border: none; }
        .palette-btn.review { background: #a29bfe; color: white; border: none; }

        /* Legend Style */
        .legend-box {
            padding: 10px 15px; background: #f8f9fa; border-top: 1px solid #eee;
            font-size: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; color: #636e72; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        /* ==================== POPUP ==================== */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .popup-box { 
            background: white; padding: 20px; border-radius: 12px; 
            width: 85%; max-width: 300px; text-align: center; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: popIn 0.3s; 
        }
        @keyframes popIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        /* Stats & Results */
        .result-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .result-table td, .result-table th { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .stat-item { background: #f4f6f8; padding: 8px; border-radius: 6px; font-size: 0.75rem; border: 1px solid #eee; }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; 
            if(e.ctrlKey && (e.keyCode == 'U'.charCodeAt(0) || e.keyCode == 'S'.charCodeAt(0))) return false;
        }
    </script>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="container" id="app-container">

    <div id="custom-popup" class="popup-overlay hidden">
        <div class="popup-box">
            <div style="font-size: 2.5rem; margin-bottom: 5px;" id="pop-icon">‚ö†Ô∏è</div>
            <h3 id="pop-title" style="margin: 5px 0; color:#2d3436; font-size:1.1rem;">Alert</h3>
            <p id="pop-msg" style="color: #636e72; margin-bottom: 15px; font-size: 0.9rem;">Message</p>
            <div style="display:flex; gap:10px;">
                <button id="btn-pop-cancel" class="btn btn-outline" style="margin:0; flex:1; padding:8px;">Cancel</button>
                <button id="btn-pop-ok" class="btn btn-primary" style="margin:0; flex:1; padding:8px;">OK</button>
            </div>
        </div>
    </div>

    <div id="side-overlay" class="overlay-bg" onclick="togglePanel(false)"></div>
    <div id="side-panel" class="side-panel">
        <div class="exam-header" style="background:#f8f9fa;">
            <span style="font-weight:bold;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</span>
            <button onclick="togglePanel(false)" style="background:none; border:none; font-size:1.2rem;">‚úï</button>
        </div>
        <div style="flex:1; overflow-y:auto;">
            <div id="palette-grid" class="palette-grid"></div>
        </div>
        
        <div class="legend-box">
            <div class="legend-item"><span class="dot" style="background:#f9f9f9; border:1px solid #ddd;"></span> ‡¶¨‡¶æ‡¶ï‡¶ø (Not Visited)</div>
            <div class="legend-item"><span class="dot" style="background:white; border:1.5px solid #6c5ce7;"></span> ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® (Current)</div>
            <div class="legend-item"><span class="dot" style="background:#00b894;"></span> ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ</div>
            <div class="legend-item"><span class="dot" style="background:#a29bfe;"></span> ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â (Marked)</div>
        </div>

        <div style="padding:15px; border-top:1px solid #eee; background:white;">
            <button onclick="confirmSubmit()" class="btn btn-danger" style="margin:0;">üöÄ ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <div id="view-dashboard" style="display:flex; flex-direction:column; height:100%;">
        <div style="background:var(--primary-gradient); color:white; padding:20px 15px; text-align:center; border-radius:0 0 20px 20px; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.2);">
            <h3 style="font-family: var(--font-num); margin:0; font-size:1.3rem;">Mr. Stylo Academy</h3>
            <p style="margin:2px 0; opacity:0.9; font-size:0.8rem;">Premium Mock Test Platform</p>
        </div>
        
        <div class="p-20" style="flex:1; overflow-y:auto;">
            <div class="cat-scroll" id="home-cat-container">
                <div class="cat-chip active">All</div>
                </div>

            <div id="exam-list">
                <div style="text-align:center; padding:50px; color:#b2bec3;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
            </div>

            <div id="pagination-controls" class="pagination-bar hidden">
                <button onclick="changePage(-1)" id="btn-prev" class="page-btn">Previous</button>
                <span id="page-info" class="page-info font-num">Page 1</span>
                <button onclick="changePage(1)" id="btn-next" class="page-btn">Next</button>
            </div>
            
            <button onclick="switchView('admin-login')" class="btn btn-outline" style="margin-top:20px; border-style:dashed; color:#636e72; font-size:0.8rem;">üë®‚Äçüè´ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶≤‡¶ó‡¶á‡¶®</button>
        </div>

        <div class="app-footer">
            <p style="margin:0;">&copy; 2026 Mr. Stylo Academy</p>
            <p style="margin:2px 0; font-size:0.7rem;">Designed for Excellence</p>
        </div>
    </div>

    <div id="view-intro" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <div style="text-align:center; margin:20px 0;">
            <span id="intro-cat-badge" style="background:#dfe6e9; padding:4px 10px; border-radius:15px; font-size:0.8rem; color:#636e72;">Category</span>
            <h2 id="intro-title" style="color:var(--color-primary); margin:5px 0 0 0; font-size:1.4rem;">Exam Name</h2>
        </div>
        <div style="background:white; border-radius:12px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.05); margin-bottom:20px; border:1px solid #f1f2f6;">
            <div class="stat-grid" style="margin-top:0;">
                <div class="stat-item">‚è±Ô∏è ‡¶∏‡¶Æ‡ßü: <b id="intro-time" class="font-num">0</b> Min</div>
                <div class="stat-item">üìù ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: <b id="intro-q" class="font-num">0</b> Qs</div>
                <div class="stat-item">üéØ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡¶∏: <b id="intro-total-marks" class="font-num">0</b></div>
                <div class="stat-item" style="color:red;">‚ö†Ô∏è ‡¶®‡ßá‡¶ó‡ßá‡¶ü‡¶ø‡¶≠: <b id="intro-neg" class="font-num">0.25</b></div>
            </div>
        </div>
        <label style="font-weight:600; font-size:0.9rem; color:#2d3436;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input type="text" id="student-name-input" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="border:2px solid #dfe6e9; width:100%; padding:12px; border-radius:10px; margin-top:5px; outline:none;" onpaste="return false;" ondrop="return false;">
        <button onclick="startRealExam()" class="btn btn-primary" style="margin-top:20px;">üöÄ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="switchView('dashboard')" class="btn btn-outline">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
    </div>

    <div id="view-exam" class="hidden exam-layout">
        <div class="exam-header">
            <span id="timer" class="timer-badge">00:00</span>
            <span id="display-name" style="font-weight:bold; font-size:0.9rem; color:#2d3436;">Student</span>
            <button onclick="togglePanel(true)" style="background:none; border:1px solid #ddd; border-radius:8px; width:35px; height:35px; cursor:pointer;">‚ò∞</button>
        </div>
        
        <div class="scroll-area">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.75rem; color:#636e72;">
                <span id="q-topic-badge" style="background:#e1e2e6; padding:3px 10px; border-radius:15px; font-weight:bold;">General</span>
                <span class="font-num">Marks: +<span id="q-pos">1</span> / -<span id="q-neg">0.25</span></span>
            </div>
            
            <div class="question-card">
                <img id="q-image" src="" style="max-width:100%; display:none; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
                <h3 id="q-text">Loading...</h3>
                <div id="options-container"></div>
            </div>
        </div>

        <div class="footer-bar">
            <button onclick="prevQ()" class="btn btn-outline footer-btn" style="flex:0.8;">Back</button>
            <button onclick="markAndNext()" class="btn btn-outline footer-btn" style="color:#6c5ce7; border-color:#a29bfe;">Mark</button>
            <button onclick="clearResponse()" class="btn btn-outline footer-btn">Clear</button>
            <button onclick="saveAndNext()" class="btn btn-save footer-btn" style="flex:1.2;">Save</button>
        </div>
    </div>

    <div id="view-result" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <div style="background:white; border-radius:16px; padding:20px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.05); margin-bottom:20px;">
            <h3 id="res-name" style="margin:0; color:#636e72;">Student</h3>
            <div style="width:80px; height:80px; border-radius:50%; border:4px solid #f1f2f6; margin:10px auto; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <span id="res-score" class="font-num" style="font-size:1.8rem; font-weight:bold; line-height:1; color:#2d3436;">0</span>
            </div>
            <div id="res-grade" style="font-weight:bold; color:var(--color-primary); font-size:1.1rem;">Grade</div>
            
            <div class="stat-grid">
                <div class="stat-item">‚è±Ô∏è <b id="res-time" class="font-num">0m</b></div>
                <div class="stat-item">üìä <b id="res-percent" class="font-num">0%</b></div>
                <div class="stat-item" style="color:var(--color-success);">‚úÖ <b id="res-correct" class="font-num">0</b></div>
                <div class="stat-item" style="color:var(--color-danger);">‚ùå <b id="res-wrong" class="font-num">0</b></div>
            </div>
        </div>
        
        <div style="background:white; padding:15px; border-radius:12px; margin-bottom:15px;">
            <h4 style="margin:0 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">üìä ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏</h4>
            <div id="topic-analysis-container"></div>
        </div>

        <button onclick="shareExam()" class="btn btn-success" style="margin-bottom:10px;">üì≤ ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü</button>
        <button onclick="switchView('review-login')" class="btn btn-primary">üëÅÔ∏è ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ (Review)</button>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="loadLeaderboard()" class="btn btn-outline" style="flex:1;">üèÜ ‡¶Æ‡ßá‡¶ß‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</button>
            <button onclick="location.reload()" class="btn btn-outline" style="flex:1;">Home</button>
        </div>
    </div>

    <div id="view-admin-login" class="hidden p-20" style="display:flex; flex-direction:column; justify-content:center; height:100%;">
        <h2 style="text-align:center;">üîê ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶≤‡¶ó‡¶á‡¶®</h2>
        <input type="password" id="admin-pass" placeholder="Password" style="padding:12px; border:1px solid #ddd; border-radius:8px; width:100%;">
        <button onclick="checkAdmin()" class="btn btn-primary">Login</button>
        <button onclick="switchView('dashboard')" class="btn btn-danger">Back</button>
    </div>

    <div id="view-admin-menu" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <h2 style="text-align:center;">üë®‚Äçüè´ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button onclick="switchView('create-exam')" class="btn btn-primary" style="height:100px;">üìù<br>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</button>
            <button onclick="loadCategoriesAdmin()" class="btn btn-primary" style="height:100px; background:#a29bfe; color:#333;">üóÇÔ∏è<br>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</button>
            <button onclick="loadAdminResults()" class="btn btn-primary" style="background:#fab1a0; color:#333;">üìä ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü</button>
            <button onclick="loadManageExams()" class="btn btn-danger">üóëÔ∏è ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú</button>
            <button onclick="switchView('settings')" class="btn btn-outline">‚öôÔ∏è ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</button>
        </div>
        <button onclick="switchView('dashboard')" class="btn btn-outline" style="margin-top:20px;">Logout</button>
    </div>

    <div id="view-categories" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <h3>üóÇÔ∏è ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú</h3>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input type="text" id="new-cat-name" placeholder="New Category Name..." style="padding:10px; flex:1; border:1px solid #ddd; border-radius:8px;">
            <button onclick="addCategory()" class="btn btn-success" style="width:auto; margin:0;">Add</button>
        </div>
        <div id="admin-cat-list"></div>
        <button onclick="switchView('admin-menu')" class="btn btn-danger" style="margin-top:20px;">Back</button>
    </div>

    <div id="view-create-exam" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <h3>üìù ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶§‡ßà‡¶∞‡¶ø</h3>
        <input type="text" id="new-title" placeholder="Exam Name" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
        
        <label style="font-size:0.8rem; color:#666; margin-left:5px;">Category:</label>
        <select id="new-category" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; background:white;">
            <option value="General">General</option>
            </select>

        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="number" id="new-time" placeholder="Time (m)" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
            <input type="number" id="mark-correct" value="1" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
            <input type="number" id="mark-wrong" value="0.25" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:8px;">
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button onclick="toggleInputMode('json')" class="btn btn-outline" style="margin:0;">JSON</button>
            <button onclick="toggleInputMode('manual')" class="btn btn-outline" style="margin:0;">Manual</button>
        </div>
        
        <div id="mode-json"><textarea id="json-input" placeholder="Paste JSON..." style="width:100%; height:150px; border:1px solid #ddd;"></textarea></div>
        <div id="mode-manual" class="hidden">
            <div id="questions-wrapper"></div>
            <button onclick="addQuestionField()" class="btn btn-outline">‚ûï Add Q</button>
        </div>
        <div style="margin-top:20px; padding-bottom:50px;">
            <button id="btn-publish" class="btn btn-success">üöÄ PUBLISH</button>
            <button onclick="switchView('admin-menu')" class="btn btn-danger">Cancel</button>
        </div>
    </div>

    <div id="view-manage-exams" class="hidden p-20" style="overflow-y:auto; height:100%;"><h3 style="text-align:center;">Manage Exams</h3><div id="manage-exam-list"></div><button onclick="switchView('admin-menu')" class="btn btn-outline">Back</button></div>
    <div id="view-admin-results" class="hidden p-20" style="overflow-y:auto; height:100%;"><h3 style="text-align:center;">Results</h3><table class="result-table"><tbody id="result-table-body"></tbody></table><button onclick="switchView('admin-menu')" class="btn btn-danger" style="margin-top:20px;">Back</button></div>
    <div id="view-leaderboard" class="hidden p-20" style="overflow-y:auto; height:100%;"><h3 style="text-align:center;">Leaderboard</h3><p id="lb-exam-name" style="text-align:center; color:#666;"></p><div id="lb-list"></div><button onclick="switchView('result')" class="btn btn-primary" style="margin-top:20px;">Back</button></div>
    
    <div id="view-review-login" class="hidden p-20" style="display:flex; flex-direction:column; justify-content:center; height:100%;">
        <h2 style="text-align:center;">üîí Review Access</h2>
        <input type="password" id="review-pass" placeholder="Pass" style="padding:12px; width:100%; border:1px solid #ddd; border-radius:8px;">
        <button onclick="checkReviewPass()" class="btn btn-success">Submit</button>
        <button onclick="switchView('result')" class="btn btn-danger">Back</button>
    </div>

    <div id="view-review" class="hidden p-20" style="overflow-y:auto; height:100%;">
        <div style="text-align:center; margin-bottom:10px;">
            <h3>‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞</h3>
            <p id="review-student-name" style="color:var(--color-primary); font-weight:bold;"></p>
        </div>
        <div style="display:flex; gap:5px; overflow-x:auto; margin-bottom:10px;">
            <button onclick="filterReview('all')" class="btn btn-outline" style="padding:5px 15px; width:auto; margin:0;">All</button>
            <button onclick="filterReview('wrong')" class="btn btn-outline" style="padding:5px 15px; width:auto; margin:0; color:red;">Wrong</button>
            <button onclick="filterReview('correct')" class="btn btn-outline" style="padding:5px 15px; width:auto; margin:0; color:green;">Correct</button>
        </div>
        <div id="review-list" style="padding-bottom:50px;"></div>
        <button onclick="switchView('result')" class="btn btn-primary">Back</button>
    </div>

    <div id="view-settings" class="hidden p-20">
        <h3>Change Password</h3>
        <input type="text" id="new-teacher-pass" placeholder="Teacher Pass" style="padding:10px; width:100%; border:1px solid #ddd; margin-bottom:5px;">
        <input type="text" id="new-review-pass" placeholder="Review Pass" style="padding:10px; width:100%; border:1px solid #ddd;">
        <button onclick="saveSettings()" class="btn btn-success">Save</button>
        <button onclick="switchView('admin-menu')" class="btn btn-danger">Back</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, orderBy, query, Timestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyC5hrI06t9N-K4GAlLxGc6pjb0-JyNC9c8", authDomain: "myquizapp-7c5ac.firebaseapp.com", projectId: "myquizapp-7c5ac", storageBucket: "myquizapp-7c5ac.firebasestorage.app", messagingSenderId: "685862319630", appId: "1:685862319630:web:2997eda6844b3bf9d6ee5f" };
    let app, db; try { app=initializeApp(firebaseConfig); db=getFirestore(app); } catch(e){}

    let activeExam=null, currentIdx=0, userAnswers=[], reviews=[], timerInterval, studentName="", inputMode='json';
    let appSettings={teacherPass:"1234", reviewPass:"5678"};
    let allExamsData=[], categoryList=[], cheatCount=0, remainingSeconds=0, editingExamId = null;
    
    // Pagination Vars
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentFilteredExams = [];

    async function initApp() {
        try {
            const docRef = doc(db, "settings", "config");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) appSettings = docSnap.data();
            else await setDoc(docRef, appSettings);
        } catch(e){}
        loadCategoriesPublic();
        loadExams();
    }
    initApp();

    window.toggleFullScreen = () => { if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{}); };
    window.enableProtect = () => { window.onbeforeunload = function() { return "Exam running!"; }; };
    window.disableProtect = () => { window.onbeforeunload = null; };

    window.showPopup = (t, m, i, ok, hideCancel=false) => {
        document.getElementById('pop-title').innerText = t; 
        document.getElementById('pop-msg').innerText = m; 
        document.getElementById('pop-icon').innerText = i;
        const c = document.getElementById('btn-pop-cancel');
        const o = document.getElementById('btn-pop-ok');
        c.style.display = hideCancel ? 'none' : 'block';
        o.style.width = hideCancel ? '100%' : 'auto';
        document.getElementById('custom-popup').classList.remove('hidden');
        o.onclick = () => { document.getElementById('custom-popup').classList.add('hidden'); if(ok) ok(); };
        c.onclick = () => { document.getElementById('custom-popup').classList.add('hidden'); };
    };

    window.switchView = (v) => { 
        if(v === 'create-exam' && !editingExamId) resetCreateForm();
        document.querySelectorAll('.container > div').forEach(d => { 
            if(!d.id.includes('popup') && !d.id.includes('side')) d.classList.add('hidden'); 
            if(d.id === 'view-exam') d.classList.remove('exam-layout');
        }); 
        let t = document.getElementById('view-' + v); 
        t.classList.remove('hidden');
        if(v === 'exam') t.classList.add('exam-layout');
    };

    function resetCreateForm() {
        editingExamId = null;
        document.getElementById('new-title').value = "";
        document.getElementById('new-time').value = "";
        const sel = document.getElementById('new-category');
        if(sel.options.length > 0) sel.selectedIndex = 0;
        
        document.getElementById('mark-correct').value = "1";
        document.getElementById('mark-wrong').value = "0.25";
        document.getElementById('json-input').value = "";
        document.getElementById('questions-wrapper').innerHTML = "";
        document.getElementById('btn-publish').innerText = "üöÄ PUBLISH";
        document.getElementById('btn-publish').classList.remove('btn-save');
        document.getElementById('btn-publish').classList.add('btn-success');
    }

    window.togglePanel = (open) => {
        const p = document.getElementById('side-panel'), o = document.getElementById('side-overlay');
        if(open){ p.classList.add('open'); o.classList.add('active'); updatePalette(); }
        else{ p.classList.remove('open'); o.classList.remove('active'); }
    };

    // ================= CATEGORY & PAGINATION LOGIC =================

    async function loadCategoriesPublic() {
        categoryList = [];
        try {
            const s = await getDocs(query(collection(db, "categories"), orderBy("createdAt", "asc")));
            if(s.empty) categoryList = [{name: "General", id: "default"}];
            else s.forEach(d => categoryList.push({...d.data(), id: d.id}));
            renderCategories();
        } catch(e) { console.log("Cat error", e); }
    }

    function renderCategories() {
        const homeCont = document.getElementById('home-cat-container');
        let chipHtml = `<div onclick="filterExams('All')" class="cat-chip active" id="cat-all">All</div>`;
        const dropCont = document.getElementById('new-category');
        let dropHtml = ``;

        categoryList.forEach(c => {
            chipHtml += `<div onclick="filterExams('${c.name}')" class="cat-chip" id="cat-${c.name}">${c.name}</div>`;
            dropHtml += `<option value="${c.name}">${c.name}</option>`;
        });
        homeCont.innerHTML = chipHtml;
        dropCont.innerHTML = dropHtml;
    }

    window.loadCategoriesAdmin = async () => {
        window.switchView('categories');
        const listDiv = document.getElementById('admin-cat-list');
        listDiv.innerHTML = "Loading...";
        try {
            const s = await getDocs(query(collection(db, "categories"), orderBy("createdAt", "asc")));
            let h = "";
            s.forEach(d => {
                const c = d.data();
                h += `<div style="background:white; padding:10px; border-radius:8px; border:1px solid #eee; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span><b>${c.name}</b></span>
                    <button onclick="delCategory('${d.id}')" class="btn btn-danger" style="width:auto; padding:5px 12px; margin:0; font-size:0.8rem;">Delete</button>
                </div>`;
            });
            listDiv.innerHTML = h || "<p style='text-align:center;'>No categories found.</p>";
        } catch(e) { listDiv.innerHTML = "Error loading."; }
    };

    window.addCategory = async () => {
        const name = document.getElementById('new-cat-name').value.trim();
        if(!name) return showPopup("Error", "Enter Name!", "‚ö†Ô∏è");
        try {
            await addDoc(collection(db, "categories"), { name: name, createdAt: Timestamp.now() });
            document.getElementById('new-cat-name').value = "";
            loadCategoriesAdmin(); loadCategoriesPublic(); 
        } catch(e) { showPopup("Error", "Failed to add!", "‚ùå"); }
    };

    window.delCategory = (id) => {
        showPopup("Confirm", "Delete this category?", "üóëÔ∏è", async () => {
            await deleteDoc(doc(db, "categories", id));
            loadCategoriesAdmin(); loadCategoriesPublic();
        });
    };

    // ================= EXAM LIST & PAGINATION =================

    window.loadExams = async () => { 
        const l = document.getElementById('exam-list'); l.innerHTML = "<div style='text-align:center;'>‚è≥ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>"; allExamsData=[]; 
        try{ 
            const s=await getDocs(query(collection(db,"exams"),orderBy("createdAt","desc"))); 
            s.forEach(d=>{ allExamsData.push({...d.data(), id:d.id}); });
            filterExams('All');
        }catch(e){l.innerHTML="Error loading exams.";} 
    };

    window.filterExams = (cat) => {
        document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
        let activeChip = document.getElementById('cat-' + (cat === 'All' ? 'all' : cat));
        if(activeChip) activeChip.classList.add('active');

        // Filter Logic
        if (cat === 'All') {
            currentFilteredExams = allExamsData;
        } else {
            currentFilteredExams = allExamsData.filter(e => (e.category || 'General') === cat);
        }
        
        // Reset to Page 1
        currentPage = 1;
        renderExamList();
    }

    window.renderExamList = () => {
        const l = document.getElementById('exam-list');
        const pControls = document.getElementById('pagination-controls');
        
        if (currentFilteredExams.length === 0) {
            l.innerHTML = "<p style='text-align:center;'>‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶®‡ßá‡¶á</p>"; 
            pControls.classList.add('hidden');
            return;
        }

        // Pagination Logic
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageItems = currentFilteredExams.slice(startIndex, endIndex);
        const totalPages = Math.ceil(currentFilteredExams.length / itemsPerPage);

        let html = "";
        pageItems.forEach((exam) => {
            let originalIndex = allExamsData.findIndex(e => e.id === exam.id);
            html += `<div style="background:white; padding:15px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee; box-shadow:0 2px 5px rgba(0,0,0,0.02);">
                <div>
                    <span style="font-size:0.7rem; background:#dfe6e9; padding:2px 8px; border-radius:10px; color:#636e72;">${exam.category || 'General'}</span>
                    <h3 style="margin:5px 0 0 0; font-size:1.1rem;">${exam.title}</h3>
                    <p style="margin:5px 0; color:#666; font-size:0.85rem;">‚è±Ô∏è ${exam.duration}m | ${exam.questions.length}Q</p>
                </div>
                <button onclick="showIntro(${originalIndex})" class="btn btn-primary" style="width:auto; padding:8px 20px; margin:0;">Start</button>
            </div>`; 
        });
        l.innerHTML = html;

        // Update Controls
        if (totalPages > 1) {
            pControls.classList.remove('hidden');
            document.getElementById('page-info').innerText = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('btn-prev').disabled = (currentPage === 1);
            document.getElementById('btn-next').disabled = (currentPage === totalPages);
        } else {
            pControls.classList.add('hidden');
        }
    }

    window.changePage = (dir) => {
        currentPage += dir;
        renderExamList();
    }

    window.showIntro=(idx)=>{ 
        activeExam=allExamsData[idx]; window.switchView('intro'); 
        let pos=activeExam.marking?activeExam.marking.correct:1;
        document.getElementById('intro-title').innerText=activeExam.title; 
        document.getElementById('intro-time').innerText=activeExam.duration; 
        document.getElementById('intro-q').innerText=activeExam.questions.length; 
        document.getElementById('intro-cat-badge').innerText=activeExam.category || "General";
        document.getElementById('intro-total-marks').innerText=activeExam.questions.length*pos;
        document.getElementById('intro-neg').innerText=activeExam.marking?activeExam.marking.wrong:0.25;
    };

    window.startRealExam=()=>{ 
        studentName=document.getElementById('student-name-input').value; 
        if(!studentName) return showPopup("Alert","‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!","‚úçÔ∏è"); 
        
        toggleFullScreen(); enableProtect();
        activeExam.questions = activeExam.questions.sort(() => Math.random() - 0.5);
        userAnswers=new Array(activeExam.questions.length).fill(null); 
        reviews=new Array(activeExam.questions.length).fill(false);
        currentIdx=0; cheatCount=0;
        document.getElementById('display-name').innerText=studentName; 
        document.getElementById('q-pos').innerText=activeExam.marking?activeExam.marking.correct:1;
        document.getElementById('q-neg').innerText=activeExam.marking?activeExam.marking.wrong:0.25;
        window.switchView('exam'); generatePalette(); loadQuestion(); 
        startTimer(activeExam.duration*60); 
        document.addEventListener("visibilitychange", handleCheat); 
    };

    function generatePalette(){
        let html=""; for(let i=0; i<activeExam.questions.length; i++) html+=`<div onclick="jumpToQ(${i})" id="pal-${i}" class="palette-btn">${i+1}</div>`;
        document.getElementById('palette-grid').innerHTML=html;
    }
    window.jumpToQ=(idx)=>{ currentIdx=idx; loadQuestion(); togglePanel(false); };

    function loadQuestion(){ 
        const q=activeExam.questions[currentIdx]; 
        document.getElementById('q-text').innerText=`Q${currentIdx+1}. ${q.q}`; 
        document.getElementById('q-topic-badge').innerText=q.topic||"General";
        const img=document.getElementById('q-image');
        if(q.image){ img.src=q.image; img.style.display='block'; } else { img.style.display='none'; }
        let h=""; q.options.forEach(o=>{ h+=`<div onclick="selOpt('${o}')" class="option-btn ${userAnswers[currentIdx]===o?'selected':''}">${o}</div>`; }); 
        document.getElementById('options-container').innerHTML=h; 
        updatePalette();
    }
    function updatePalette(){
        document.querySelectorAll('.palette-btn').forEach((b,i)=>{
            b.className='palette-btn'; 
            if(i===currentIdx) b.classList.add('active');
            if(userAnswers[i]) b.classList.add('answered');
            if(reviews[i]) b.classList.add('review');
        });
    }

    window.selOpt=(o)=>{ userAnswers[currentIdx]=o; loadQuestion(); };
    window.markAndNext=()=>{ reviews[currentIdx]=true; window.nextQ(); };
    window.clearResponse=()=>{ userAnswers[currentIdx]=null; reviews[currentIdx]=false; loadQuestion(); };
    window.saveAndNext=()=>{ if(userAnswers[currentIdx]) reviews[currentIdx]=false; window.nextQ(); };
    window.prevQ=()=>{ if(currentIdx > 0){ currentIdx--; loadQuestion(); } else { showPopup("Info","‡¶è‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®!","‚ÑπÔ∏è"); } };
    window.nextQ=()=>{ if(currentIdx<activeExam.questions.length-1){ currentIdx++; loadQuestion(); } else { showPopup("End","‡¶∂‡ßá‡¶∑ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®! ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§","üèÅ", ()=>togglePanel(true)); } };
    window.confirmSubmit=()=>{ showPopup("Submit?","‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?","üöÄ", window.submitExam); };

    function handleCheat(){
        if(document.hidden){
            cheatCount++;
            if(cheatCount >= 3) showPopup("Violation", "‡ß© ‡¶¨‡¶æ‡¶∞ ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç ‡¶∂‡ßá‡¶∑! ‡¶Ö‡¶ü‡ßã ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü‡•§", "üö´", window.submitExam, true);
            else showPopup("Warning", `‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ! ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶®‡¶ø‡¶Ç: ${cheatCount}/3`, "‚ö†Ô∏è", null, true);
        }
    }

    window.submitExam=async()=>{ 
        togglePanel(false); disableProtect(); 
        clearInterval(timerInterval); document.removeEventListener("visibilitychange", handleCheat); 
        let score=0, correct=0, wrong=0;
        let pos=activeExam.marking?activeExam.marking.correct:1, neg=activeExam.marking?activeExam.marking.wrong:0.25;
        let topicStats={};
        activeExam.questions.forEach((q,i)=>{ 
            let t=q.topic||"Others"; if(!topicStats[t]) topicStats[t]={total:0,correct:0}; topicStats[t].total++;
            if(userAnswers[i]===q.answer){ score+=parseFloat(pos); correct++; topicStats[t].correct++; }
            else if(userAnswers[i]){ score-=parseFloat(neg); wrong++; }
        });
        if(score<0) score=0;
        let totalSec=activeExam.duration*60; let taken=totalSec-remainingSeconds;
        let mm=Math.floor(taken/60), ss=taken%60;
        let percent=(score/(activeExam.questions.length*pos))*100;
        let th="";
        for(let t in topicStats){
            let p=(topicStats[t].correct/topicStats[t].total)*100;
            let c=p>=80?'#00b894':(p>=40?'#fdcb6e':'#d63031');
            th+=`<div style="margin-bottom:8px;"><div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;"><span>${t}</span><span>${Math.round(p)}%</span></div><div style="width:100%; background:#f1f2f6; height:6px; border-radius:10px;"><div style="height:100%; border-radius:10px; width:${p}%; background:${c};"></div></div></div>`;
        }
        window.switchView('result'); 
        document.getElementById('res-score').innerText=score.toFixed(2); 
        document.getElementById('res-percent').innerText=percent.toFixed(1)+"%"; 
        document.getElementById('res-grade').innerText=percent>=80?"A+":percent>=60?"A":percent>=40?"B":"F";
        document.getElementById('res-time').innerText=`${mm}m ${ss}s`;
        document.getElementById('res-correct').innerText=correct;
        document.getElementById('res-wrong').innerText=wrong;
        document.getElementById('topic-analysis-container').innerHTML=th;
        try{ confetti({particleCount:150,spread:70,origin:{y:0.6}}); }catch(e){}
        try{ await addDoc(collection(db,"results"),{name:studentName, exam:activeExam.title, score:score.toFixed(2), percent:percent.toFixed(1), createdAt:Timestamp.now()}); }catch(e){}
    };

    function startTimer(s){ 
        remainingSeconds=s; clearInterval(timerInterval); 
        timerInterval=setInterval(()=>{ 
            let m=Math.floor(remainingSeconds/60), sc=remainingSeconds%60; 
            document.getElementById('timer').innerText=`${m}:${sc<10?'0':''}${sc}`; 
            if(remainingSeconds--<=0){ clearInterval(timerInterval); showPopup("Time Up","‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑!","‚åõ", window.submitExam, true); } 
        },1000); 
    }

    // Admin & Utils
    window.checkAdmin=()=>{ if(document.getElementById('admin-pass').value===appSettings.teacherPass) window.switchView('admin-menu'); else showPopup("Error","‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!","‚ùå"); };
    window.saveSettings=async()=>{ let t=document.getElementById('new-teacher-pass').value, r=document.getElementById('new-review-pass').value; if(t&&r){ appSettings={teacherPass:t, reviewPass:r}; await setDoc(doc(db,"settings","config"),appSettings); showPopup("Success","Saved!","‚úÖ",()=>window.switchView('admin-menu')); } };
    
    window.toggleInputMode=(m)=>{ inputMode=m; document.getElementById('mode-json').classList.toggle('hidden',m!=='json'); document.getElementById('mode-manual').classList.toggle('hidden',m!=='manual'); if(m==='manual' && document.getElementById('questions-wrapper').children.length===0) window.addQuestionField(); };
    window.addQuestionField=()=>{
        const id=Date.now();
        const h=`<div class="exam-card" id="q-${id}" style="background:#f9f9f9; padding:10px; border:1px solid #ddd; margin-bottom:10px; border-radius:8px;">
            <input type="text" class="inp-q" placeholder="Question..." style="margin-bottom:5px; width:100%; padding:8px;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"><input type="text" class="inp-topic" placeholder="Topic"><input type="text" class="inp-img" placeholder="Img URL"></div>
            <div id="opts-${id}">${getOpt(id,1)}${getOpt(id,2)}${getOpt(id,3)}${getOpt(id,4)}</div>
            <textarea class="inp-exp" placeholder="‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ (Explanation)..." style="width:100%; height:50px; padding:8px; border:1px solid #ddd; border-radius:5px; margin-top:5px;"></textarea>
            <button onclick="document.getElementById('q-${id}').remove()" class="btn btn-danger" style="padding:5px; width:auto; font-size:0.8rem; margin-top:5px;">Delete</button>
        </div>`;
        document.getElementById('questions-wrapper').insertAdjacentHTML('beforeend', h);
    };
    function getOpt(id,n){ return `<div style="display:flex; gap:5px; margin-bottom:5px;"><input type="radio" name="ans-${id}" value="${n-1}"><input type="text" class="inp-opt" placeholder="Op ${n}" style="padding:8px;"></div>`; }

    document.getElementById('btn-publish').addEventListener('click', async()=>{
        const t=document.getElementById('new-title').value; 
        const cat = document.getElementById('new-category').value; 
        let q=[];
        
        if(inputMode==='json'){ try{ let j=JSON.parse(document.getElementById('json-input').value); q=Array.isArray(j)?j:(j.questions||[]); }catch(e){ return showPopup("Error","JSON Error","‚ö†Ô∏è"); } }
        else {
            document.querySelectorAll('#questions-wrapper .exam-card').forEach(c=>{
                let qt=c.querySelector('.inp-q').value, ops=[], ans=null;
                c.querySelectorAll('.inp-opt').forEach((o,i)=>{ if(o.value){ ops.push(o.value); if(o.parentElement.querySelector('input[type="radio"]').checked) ans=o.value; } });
                let exp = c.querySelector('.inp-exp').value || null;
                if(qt && ops.length>1 && ans) q.push({q:qt, options:ops, answer:ans, topic:c.querySelector('.inp-topic').value||"Gen", image:c.querySelector('.inp-img').value||null, explanation:exp});
            });
        }
        if(!t || q.length===0) return showPopup("Error","‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®!","‚ö†Ô∏è");
        
        const payload = {
            title:t, duration:document.getElementById('new-time').value, category: cat, questions:q, 
            marking:{ correct:document.getElementById('mark-correct').value, wrong:document.getElementById('mark-wrong').value }, 
            createdAt:Timestamp.now()
        };

        try{ 
            if(editingExamId) {
                await setDoc(doc(db, "exams", editingExamId), payload);
                showPopup("Success", "Updated!", "‚úÖ", () => { editingExamId = null; window.switchView('admin-menu'); });
            } else {
                await addDoc(collection(db, "exams"), payload); 
                showPopup("Success", "Published!", "‚úÖ", () => window.switchView('admin-menu')); 
            }
        } catch(e) { showPopup("Error", "Failed!", "‚ùå"); }
    });

    window.editExam = async (id) => {
        showPopup("Loading", "‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...", "‚è≥", null, true);
        try {
            const docSnap = await getDoc(doc(db, "exams", id));
            if(docSnap.exists()){
                const d = docSnap.data();
                editingExamId = id;
                document.getElementById('new-title').value = d.title;
                document.getElementById('new-time').value = d.duration;
                document.getElementById('new-category').value = d.category || 'General';
                if(d.marking){ document.getElementById('mark-correct').value = d.marking.correct; document.getElementById('mark-wrong').value = d.marking.wrong; }
                window.toggleInputMode('json');
                document.getElementById('json-input').value = JSON.stringify(d.questions, null, 4);
                const btn = document.getElementById('btn-publish');
                btn.innerText = "üîÑ UPDATE EXAM";
                btn.classList.remove('btn-success');
                btn.classList.add('btn-save');
                document.getElementById('custom-popup').classList.add('hidden');
                window.switchView('create-exam');
            }
        } catch(e) { showPopup("Error", "Load Error", "‚ùå"); }
    };

    window.loadManageExams=async()=>{ 
        window.switchView('manage-exams'); document.getElementById('manage-exam-list').innerHTML="Loading..."; 
        const s=await getDocs(query(collection(db,"exams"),orderBy("createdAt","desc"))); 
        let h=""; s.forEach(d=>{
            h+=`<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee; gap:10px;">
                <span style="flex:1;">${d.data().title} <small style="color:#666">(${d.data().category||'Gen'})</small></span>
                <button onclick="editExam('${d.id}')" class="btn btn-primary" style="width:auto; padding:5px 12px; margin:0; font-size:0.8rem;">Edit</button>
                <button onclick="delExam('${d.id}')" class="btn btn-danger" style="width:auto; padding:5px 12px; margin:0; font-size:0.8rem;">Del</button>
            </div>`;
        }); 
        document.getElementById('manage-exam-list').innerHTML=h||"No Exams"; 
    };

    window.delExam=(id)=>{ showPopup("Delete?","‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?","üóëÔ∏è",async()=>{ await deleteDoc(doc(db,"exams",id)); loadManageExams(); }); };
    window.checkReviewPass=()=>{ if(document.getElementById('review-pass').value===appSettings.reviewPass) window.showReview(); else showPopup("Error","‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!","‚ùå"); };
    window.showReview=()=>{ 
        let h=""; document.getElementById('review-student-name').innerText=studentName; 
        activeExam.questions.forEach((q,i)=>{ 
            let s=(userAnswers[i]===q.answer)?"correct":(userAnswers[i]?"wrong":"skipped");
            let c=s==="correct"?"#00b894":(s==="wrong"?"#d63031":"#636e72");
            h+=`<div class="review-item ${s}" style="background:white; padding:15px; margin-bottom:10px; border-left:4px solid ${c}; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <p style="margin:0 0 5px 0;"><b>Q${i+1}. ${q.q}</b></p>
                <p style="font-size:0.85rem; color:#666;">You: <b style="color:${c}">${userAnswers[i]||'Skipped'}</b> | Ans: <b style="color:#00b894">${q.answer}</b></p>
                <div style="background:#f1f2f6; padding:8px; font-size:0.85rem; margin-top:5px; border-radius:5px;">üí° ${q.explanation || 'No Explanation'}</div>
            </div>`; 
        }); document.getElementById('review-list').innerHTML=h; window.switchView('review'); 
    };
    window.filterReview=(t)=>{ document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); document.querySelectorAll('.review-item').forEach(i=>{ i.style.display=(t==='all'||i.classList.contains(t))?'block':'none'; }); };
    window.loadAdminResults=async()=>{ window.switchView('admin-results'); document.getElementById('result-table-body').innerHTML="Loading..."; const s=await getDocs(query(collection(db,"results"),orderBy("createdAt","desc"))); let h=""; s.forEach(d=>{let v=d.data(); h+=`<tr style="border-bottom:1px solid #eee;"><td>${v.name}</td><td>${v.exam}</td><td>${v.score}</td></tr>`;}); document.getElementById('result-table-body').innerHTML=h||"<tr><td>No Data</td></tr>"; };
    window.loadLeaderboard=async()=>{ window.switchView('leaderboard'); document.getElementById('lb-exam-name').innerText=activeExam.title; document.getElementById('lb-list').innerHTML="Loading..."; const s=await getDocs(query(collection(db,"results"),orderBy("score","desc"))); let h="<table style='width:100%; font-size:0.9rem;'><tr><th>Rank</th><th>Name</th><th>Score</th></tr>", r=1; s.forEach(d=>{let v=d.data(); if(v.exam===activeExam.title){ h+=`<tr><td style="text-align:center;">${r}</td><td>${v.name}</td><td style="text-align:center; font-weight:bold;">${v.score}</td></tr>`; r++; } }); document.getElementById('lb-list').innerHTML=r>1?h+"</table>":"No Data"; };
    window.shareExam=()=>{ if(navigator.share) navigator.share({title:activeExam.title, text:`Scored ${document.getElementById('res-score').innerText} in ${activeExam.title}!`, url:window.location.href}); else alert("Copied!"); };

</script>
</body>
</html>
